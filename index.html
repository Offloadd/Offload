<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offload: A nervous system validation companion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f9fafb;
            padding: 15px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 6px; padding: 18px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header { border-left: 4px solid #3b82f6; padding-left: 15px; }
        .section-blue { border-left: 4px solid #3b82f6; }
        .section-purple { border-left: 4px solid #9333ea; }
        h1 { font-size: 22px; margin-bottom: 6px; color: #111827; }
        h2 { font-size: 18px; margin-bottom: 9px; color: #111827; }
        .subtitle { color: #6b7280; font-size: 13px; margin-bottom: 12px; }
        .slider-container { background: #f9fafb; padding: 6px; border-radius: 4px; margin-bottom: 5px; position: relative; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .slider-label { font-weight: 600; color: #111827; font-size: 14px; flex: 1; }
        .slider-value { font-size: 18px; font-weight: bold; }
        .slider-actions { display: flex; gap: 4px; margin-left: 8px; }
        .icon-btn { 
            background: none; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            padding: 4px 6px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .icon-btn:hover { background: rgba(0,0,0,0.05); }
        .icon-btn:active { background: rgba(0,0,0,0.1); }
        input[type="range"] { 
            width: 100%; 
            height: 6px; 
            border-radius: 3px; 
            outline: none; 
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type="text"], textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            font-size: 14px;
            font-family: inherit;
        }
        textarea { min-height: 50px; resize: vertical; }
        .input-label { font-size: 13px; font-weight: 600; color: #374151; margin-top: 6px; margin-bottom: 3px; display: block; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 10px; color: #6b7280; margin-bottom: 2px; }
        .meta-layer { position: relative; height: 16px; margin-bottom: 4px; }
        .meta-lines { position: absolute; top: 0; left: 0; right: 0; height: 100%; display: flex; }
        .meta-line { position: absolute; top: 0; height: 100%; width: 1px; border-left: 2px dashed #9ca3af; }
        .meta-line-left { left: 33.33%; }
        .meta-line-right { left: 66.67%; }
        .meta-labels { display: flex; justify-content: space-between; font-size: 9px; color: #6b7280; font-style: italic; padding: 0 2px; }
        .meta-label { flex: 1; text-align: center; }
        .life-areas-container { position: relative; }
        .life-areas-dividers { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 1; }
        .divider-line { position: absolute; top: 0; bottom: 0; width: 1px; border-left: 2px dashed #d1d5db; opacity: 0.6; }
        .divider-left { left: 33.33%; }
        .divider-right { left: 66.67%; }
        .slider-marks-container { position: relative; }
        .slider-marks { display: flex; justify-content: space-between; align-items: flex-start; height: 10px; margin-top: 2px; }
        .slider-mark { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .slider-mark-number { font-size: 9px; color: #6b7280; margin-top: 1px; font-weight: 500; }
        .subtotal { background: #dbeafe; border: 2px solid #93c5fd; padding: 8px; border-radius: 4px; margin-top: 6px; }
        .subtotal-text { font-size: 14px; font-weight: bold; color: #111827; }
        .total-box { background: #fee2e2; border: 2px solid #fca5a5; padding: 18px; border-radius: 6px; text-align: center; margin-bottom: 12px; }
        .total-label { color: #6b7280; font-size: 13px; margin-bottom: 3px; }
        .total-value { font-size: 40px; font-weight: bold; color: #dc2626; margin-bottom: 6px; }
        .total-percent { font-size: 28px; font-weight: bold; color: #dc2626; }
        .status-box { padding: 12px; border-radius: 6px; border: 2px solid; display: flex; align-items: center; gap: 8px; }
        .status-icon { font-size: 20px; }
        .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-success { background: #16a34a; color: white; width: 100%; padding: 10px; font-size: 15px; }
        .btn-success:hover { background: #15803d; }
        .btn-success:disabled { background: #d1d5db; cursor: not-allowed; }
        .btn-toggle { background: #3b82f6; color: white; margin-bottom: 12px; }
        .btn-toggle:hover { background: #2563eb; }
        .btn-add { background: #8b5cf6; color: white; width: 100%; margin-top: 8px; }
        .btn-add:hover { background: #7c3aed; }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        .modal-title { font-size: 20px; font-weight: 700; color: #111827; }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        .modal-close:hover { background: #f3f4f6; }
        .modal-body { margin-bottom: 18px; }
        .modal-footer {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .modal-footer .btn { padding: 10px 20px; }
        .btn-cancel { background: #6b7280; color: white; }
        .btn-cancel:hover { background: #4b5563; }
        .btn-save { background: #16a34a; color: white; }
        .btn-save:hover { background: #15803d; }
        
        .hidden { display: none; }
        
        .visualization {
            position: relative;
            width: 100%;
            height: 300px;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            background: #44ff44;
            transition: background-color 0.3s ease-out;
        }

        .color-legend {
            position: absolute;
            left: 10px;
            top: 10px;
            bottom: 10px;
            width: 25px;
            background: linear-gradient(to bottom,
                #ff4444 0%,
                #ffaa44 33%,
                #4488ff 66%,
                #44ff44 100%
            );
            border: 2px solid #333;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 9;
        }

        .zone-labels {
            position: absolute;
            left: 45px;
            width: 180px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            pointer-events: none;
            z-index: 10;
        }

        .zone-label {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 12px;
            padding: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .visualization svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .river-channel {
            fill: rgba(135, 206, 250, 0.6);
            stroke: #4682b4;
            stroke-width: 2;
            transition: d 0.3s ease-out;
        }

        .river-water {
            fill: url(#waterGradient);
            opacity: 0.8;
            transition: d 0.3s ease-out;
        }

        .gate-top {
            position: absolute;
            left: 35%;
            top: 0;
            width: 100px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            z-index: 5;
            transform: translateX(-50%);
        }

        .gate-bottom {
            position: absolute;
            left: 35%;
            bottom: 0;
            width: 100px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            z-index: 5;
            transform: translateX(-50%);
        }

        .gate-shape-top {
            width: 100%;
            position: relative;
            transition: height 0.3s ease-out;
        }

        .gate-shape-bottom {
            width: 100%;
            position: relative;
            transition: height 0.3s ease-out;
        }

        .gate-interior-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 100%;
            background: rgba(255, 100, 100, 0.3);
            border-radius: 0 0 50% 50%;
            z-index: 1;
        }

        .gate-interior-bottom {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 100%;
            background: rgba(100, 255, 100, 0.3);
            border-radius: 50% 50% 0 0;
            z-index: 1;
        }

        .gate-outline-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            border: 4px solid #222;
            border-top: none;
            border-radius: 0 0 50% 50%;
            background: transparent;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            z-index: 2;
        }

        .gate-outline-bottom {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            border: 4px solid #222;
            border-bottom: none;
            border-radius: 50% 50% 0 0;
            background: transparent;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            z-index: 2;
        }

        .gate-text-top {
            position: absolute;
            left: 35%;
            transform: translateX(-50%);
            top: 0;
            color: white;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            z-index: 6;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            transition: top 0.3s ease-out;
            pointer-events: none;
        }

        .gate-text-bottom {
            position: absolute;
            left: 35%;
            transform: translateX(-50%);
            bottom: 0;
            color: white;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            z-index: 6;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            transition: bottom 0.3s ease-out;
            pointer-events: none;
        }

        .river-text {
            position: absolute;
            left: 45%;
            right: auto;
            width: 200px;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            z-index: 6;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            pointer-events: none;
            transition: top 0.3s ease-out, font-size 0.3s ease-out, letter-spacing 0.3s ease-out;
            transform: translateY(-50%);
            white-space: normal;
            line-height: 1.2;
        }
        
        .neutral-list {
            position: absolute;
            left: 80%;
            color: white;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 6;
            pointer-events: none;
            transition: top 0.3s ease-out;
            transform: translateY(-50%);
            max-width: 250px;
        }
        
        .neutral-item {
            margin-bottom: 2px;
            line-height: 1.3;
        }

        .ground-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            z-index: 15;
        }
        
        .contributors-list {
            position: absolute;
            right: 40px;
            color: white;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 6;
            pointer-events: none;
            max-width: 300px;
        }
        
        .contributors-threat {
            top: 10px;
        }
        
        .contributors-opportunity {
            bottom: 10px;
        }
        
        .contributor-item {
            margin-bottom: 2px;
            line-height: 1.3;
        }
        
        .how-it-works { margin-top: 12px; }
        .how-item { margin-bottom: 9px; color: #374151; font-size: 13px; }
        .how-label { font-weight: 600; }
        .examples-box { 
            background: #f3f4f6; 
            border: 2px solid #d1d5db; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 15px;
        }
        .examples-title { 
            font-weight: 700; 
            color: #111827; 
            margin-bottom: 6px; 
            font-size: 14px;
        }
        .examples-list { 
            font-size: 13px; 
            color: #374151; 
            line-height: 1.5;
        }
        .entry-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .entry-timestamp {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 9px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e5e7eb;
        }
        .entry-section {
            margin-bottom: 9px;
        }
        .entry-section-title {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .entry-life-areas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 12px;
            color: #374151;
        }
        .entry-ambient {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 6px;
        }
        .entry-ambient-header {
            font-weight: 600;
            color: #111827;
            margin-bottom: 3px;
            font-size: 13px;
        }
        .entry-ambient-note {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
            margin-top: 3px;
        }
        .entry-total {
            background: #fee2e2;
            padding: 9px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #dc2626;
            font-size: 15px;
        }
        .error-message {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 9px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Edit Life Area</h3>
                <button class="modal-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body">
                <label class="input-label">Life Area Name:</label>
                <input type="text" id="editName" placeholder="e.g., Mental Activity">
                
                <label class="input-label">Positive Label (+5):</label>
                <textarea id="editPositive" placeholder="Description for the positive/enthusiastic end of the slider..."></textarea>
                
                <label class="input-label">Neutral Label (0):</label>
                <textarea id="editNeutral" placeholder="Description for the neutral/regulated center..."></textarea>
                
                <label class="input-label">Negative Label (-5):</label>
                <textarea id="editNegative" placeholder="Description for the negative/dysregulated end..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn btn-save" onclick="saveLifeAreaEdit()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Default life areas configuration
        const DEFAULT_LIFE_AREAS = [
            {
                key: 'mental',
                label: 'Mental Activity',
                positiveLabel: '+5 Creative, Pleasant, Enjoyable (beware overly fantasizing)',
                neutralLabel: '0 Think about self compassion/forgiveness and body awareness',
                negativeLabel: '-5 Avoidant/Racing Thoughts, Ruminating, Catastrophizing'
            },
            {
                key: 'somaticBody',
                label: 'Somatic &/or Body',
                positiveLabel: '+5 Calm, relaxed, can easily tolerate discomforts',
                neutralLabel: '0 Able to force tolerating discomforts while resting/relaxing',
                negativeLabel: '-5 Body aches/pains or other physical symptoms'
            },
            {
                key: 'emotional',
                label: 'Emotional',
                positiveLabel: '+5 Enthusiasm/Fun',
                neutralLabel: '0 Deeply Calm (Regulated)',
                negativeLabel: '-5 Fear, Anger, or Activated (Dysregulated)'
            },
            {
                key: 'housingComforts',
                label: 'Housing & Creature Comforts',
                positiveLabel: '+5 Able to embrace, enjoy, or appreciate simple creature comforts',
                neutralLabel: '0 Deeply Calm (Regulated)',
                negativeLabel: '-5 Pressure to pursue or engage in home improvement projects'
            },
            {
                key: 'workMoney',
                label: 'Work Experiences & Income Generation',
                positiveLabel: '+5 A calmable enthusiasm for work/money related tasks',
                neutralLabel: '0 Have some willingness to pursue/engage in income generating efforts',
                negativeLabel: '-5 Intense or persistent anticipation, rumination, or pressure to perform'
            },
            {
                key: 'moneyHandling',
                label: 'Money & Resource Handling',
                positiveLabel: '+5 Curiosity or thinking about paying down debt or investing into business related things',
                neutralLabel: '0 Not really thinking or worrying about money or resources at all',
                negativeLabel: '-5 Fear about financial failure or obsessions about money monitoring'
            },
            {
                key: 'spiritual',
                label: 'Personal Relationships or Interactions',
                positiveLabel: '+5 Able and willing to practice tolerance of information while interacting',
                neutralLabel: '0 Can neutralize overly negative thoughts/narratives',
                negativeLabel: '-5 Resentments, blaming, catastrophizing, external critic, and prolonged avoidance'
            },
            {
                key: 'freedomLevel',
                label: 'Spiritual Level Outlook',
                positiveLabel: '+5 Supportive random synchronicities, consilience leading to approachability',
                neutralLabel: '0 Neutral or between the extremes',
                negativeLabel: '-5 Parts of society/other people are unsupportive of my needs and wants'
            }
        ];

        const state = {
            lifeAreas: {},
            lifeAreasConfig: [],
            lifeAreasVisible: true,
            ambient: [
                { value: 0, type: 'draining_positive', note: '' },
                { value: 0, type: 'draining_positive', note: '' },
                { value: 0, type: 'draining_positive', note: '' }
            ],
            entries: [],
            saveError: '',
            editingKey: null
        };

        // Initialize from localStorage or defaults
        function initializeState() {
            // Load life areas config
            const savedConfig = localStorage.getItem('offload_life_areas_config');
            if (savedConfig) {
                state.lifeAreasConfig = JSON.parse(savedConfig);
            } else {
                state.lifeAreasConfig = [...DEFAULT_LIFE_AREAS];
                saveLifeAreasConfig();
            }

            // Initialize lifeAreas values
            state.lifeAreasConfig.forEach(config => {
                state.lifeAreas[config.key] = 0;
            });

            // Load visibility preference
            const savedVisibility = localStorage.getItem('offload_life_areas_visible');
            if (savedVisibility !== null) {
                state.lifeAreasVisible = savedVisibility === 'true';
            }
        }

        function saveLifeAreasConfig() {
            localStorage.setItem('offload_life_areas_config', JSON.stringify(state.lifeAreasConfig));
        }

        function saveVisibilityPreference() {
            localStorage.setItem('offload_life_areas_visible', state.lifeAreasVisible);
        }

        function toggleLifeAreasVisibility() {
            state.lifeAreasVisible = !state.lifeAreasVisible;
            saveVisibilityPreference();
            render();
        }

        function openEditModal(key) {
            state.editingKey = key;
            const config = state.lifeAreasConfig.find(c => c.key === key);
            
            document.getElementById('modalTitle').textContent = 'Edit Life Area';
            document.getElementById('editName').value = config.label;
            document.getElementById('editPositive').value = config.positiveLabel;
            document.getElementById('editNeutral').value = config.neutralLabel;
            document.getElementById('editNegative').value = config.negativeLabel;
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function openAddModal() {
            if (state.lifeAreasConfig.length >= 10) {
                alert('Maximum of 10 life areas allowed');
                return;
            }
            
            state.editingKey = null;
            
            document.getElementById('modalTitle').textContent = 'Add Life Area';
            document.getElementById('editName').value = '';
            document.getElementById('editPositive').value = '';
            document.getElementById('editNeutral').value = '';
            document.getElementById('editNegative').value = '';
            
            document.getElementById('modalOverlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            state.editingKey = null;
        }

        function saveLifeAreaEdit() {
            const name = document.getElementById('editName').value.trim();
            const positive = document.getElementById('editPositive').value.trim();
            const neutral = document.getElementById('editNeutral').value.trim();
            const negative = document.getElementById('editNegative').value.trim();

            if (!name || !positive || !neutral || !negative) {
                alert('All fields are required');
                return;
            }

            if (state.editingKey) {
                // Edit existing
                const config = state.lifeAreasConfig.find(c => c.key === state.editingKey);
                config.label = name;
                config.positiveLabel = positive;
                config.neutralLabel = neutral;
                config.negativeLabel = negative;
            } else {
                // Add new
                const newKey = 'custom_' + Date.now();
                state.lifeAreasConfig.push({
                    key: newKey,
                    label: name,
                    positiveLabel: positive,
                    neutralLabel: neutral,
                    negativeLabel: negative
                });
                state.lifeAreas[newKey] = 0;
            }

            saveLifeAreasConfig();
            closeModal();
            render();
        }

        function deleteLifeArea(key) {
            if (!confirm('Delete this life area? This cannot be undone.')) {
                return;
            }

            state.lifeAreasConfig = state.lifeAreasConfig.filter(c => c.key !== key);
            delete state.lifeAreas[key];
            
            saveLifeAreasConfig();
            render();
        }

        function getSliderColor(value) {
            // Value comes in negated for display
            if (value > 0) {
                // Green gradient: lighter at +1, darker at +5 (energizing)
                const intensity = value / 5; // 0.2 to 1.0
                const red = Math.round(100 - (100 * intensity)); // 100 to 0
                const green = Math.round(220 + (35 * intensity)); // 220 to 255
                const blue = Math.round(100 - (100 * intensity)); // 100 to 0
                return `rgb(${red}, ${green}, ${blue})`;
            } else if (value < 0) {
                const absValue = Math.abs(value);
                if (absValue <= 1.5) {
                    // Transition from blue to yellow/orange (0 to -1.5)
                    const intensity = absValue / 1.5; // 0 to 1
                    const red = Math.round(68 + (200 * intensity)); // 68 to 268 -> capped at 255
                    const green = Math.round(136 + (100 * intensity)); // 136 to 236
                    const blue = Math.round(255 - (155 * intensity)); // 255 to 100
                    return `rgb(${Math.min(red, 255)}, ${Math.min(green, 255)}, ${blue})`;
                } else {
                    // Yellow/orange to red gradient (-1.5 to -5)
                    const intensity = (absValue - 1.5) / 3.5; // 0 to 1
                    const red = 255; // Stay at max red
                    const green = Math.round(236 - (136 * intensity)); // 236 to 100
                    const blue = Math.round(100 - (100 * intensity)); // 100 to 0
                    return `rgb(${red}, ${green}, ${blue})`;
                }
            } else {
                return 'rgb(68, 136, 255)'; // Blue for 0
            }
        }

        function getTotal() {
            // Negate life areas so positive values (draining) make total more negative
            const lifeTotal = -Object.values(state.lifeAreas).reduce((sum, val) => sum + val, 0);
            
            // Calculate ambient contribution based on type
            let ambientContribution = 0;
            state.ambient.forEach(amb => {
                if (amb.value !== 0) {
                    if (amb.type === 'draining_positive' || amb.type === 'draining_negative') {
                        // Draining types add to load (make number more negative)
                        ambientContribution -= amb.value;
                    } else if (amb.type === 'expansive_positive') {
                        // Expansive/calming reduces load (make number more positive)
                        ambientContribution += amb.value;
                    }
                    // productive_negative is neutral (0) for now
                }
            });
            
            return lifeTotal + ambientContribution;
        }

        function getThreatLoad() {
            // Sum all negative values (threat/activation)
            let threatTotal = 0;
            let lifeAreaThreat = 0;
            let ambientThreat = 0;
            
            Object.values(state.lifeAreas).forEach(val => {
                if (val > 0) {
                    lifeAreaThreat += val; // Positive slider values are threat
                }
            });
            
            // Add draining ambient experiences
            state.ambient.forEach(amb => {
                if (amb.value !== 0 && (amb.type === 'draining_positive' || amb.type === 'draining_negative')) {
                    ambientThreat += amb.value;
                }
            });
            
            threatTotal = lifeAreaThreat + ambientThreat;
            return threatTotal;
        }

        function getOpportunityLoad() {
            // Sum all positive values (opportunity/enthusiasm)
            let opportunityTotal = 0;
            let lifeAreaOpp = 0;
            let ambientOpp = 0;
            
            Object.values(state.lifeAreas).forEach(val => {
                if (val < 0) {
                    lifeAreaOpp += Math.abs(val); // Negative slider values are opportunity
                }
            });
            
            // Add expansive ambient experiences AND productive negative experiences
            state.ambient.forEach(amb => {
                if (amb.value !== 0 && (amb.type === 'expansive_positive' || amb.type === 'productive_negative')) {
                    ambientOpp += amb.value;
                }
            });
            
            opportunityTotal = lifeAreaOpp + ambientOpp;
            return opportunityTotal;
        }

        function getNeutralCount() {
            // Count how many life areas are at zero
            return Object.values(state.lifeAreas).filter(val => val === 0).length;
        }

        function getPercentage() {
            const total = getTotal();
            // Map -30 (max load) to 100%, +10 (min load) to 0%
            // Range is 40 total: from -30 to +10
            const normalized = (-total + 10) / 40; // Convert to 0-1 range (flip sign so -30 maps to 1)
            return Math.round(Math.max(0, Math.min(100, normalized * 100)));
        }

        function getStatus() {
            const pct = getPercentage();
            if (pct >= 90) return { icon: 'üö®', text: 'Critical load - system at capacity', color: '#fee2e2', border: '#fca5a5', textColor: '#991b1b' };
            if (pct >= 75) return { icon: '‚ö†Ô∏è', text: 'High load - approaching capacity', color: '#fed7aa', border: '#fb923c', textColor: '#9a3412' };
            if (pct >= 50) return { icon: '‚ö°', text: 'Moderate load - monitoring needed', color: '#fef3c7', border: '#fcd34d', textColor: '#92400e' };
            return { icon: '‚úì', text: 'Expanded Tolerance - recovering or possible engagement', color: '#d1fae5', border: '#6ee7b7', textColor: '#065f46' };
        }

        function updateSlider(category, key, value) {
            if (category === 'life') state.lifeAreas[key] = parseInt(value);
            render();
        }

        function updateAmbient(index, field, value) {
            if (field === 'value') {
                state.ambient[index].value = parseInt(value);
            } else {
                state.ambient[index][field] = value;
            }
            render();
        }

        function validateSave() {
            const errors = [];
            state.ambient.forEach((amb, i) => {
                if (amb.value !== 0) {
                    if (!amb.type) errors.push(`Internal Activity ${i+1}: Type is required when slider is not at 0`);
                    if (!amb.note.trim()) errors.push(`Internal Activity ${i+1}: Note is required when slider is not at 0`);
                }
            });
            return errors;
        }

        function saveEntry() {
            const errors = validateSave();
            if (errors.length > 0) {
                state.saveError = errors.join('<br>');
                render();
                return;
            }

            state.saveError = '';
            const lifeTotal = -Object.values(state.lifeAreas).reduce((sum, val) => sum + val, 0);
            const threatLoad = getThreatLoad();
            const opportunityLoad = getOpportunityLoad();
            const neutralCount = getNeutralCount();
            
            const entry = {
                timestamp: new Date().toISOString(),
                lifeAreas: {...state.lifeAreas},
                lifeAreasConfig: [...state.lifeAreasConfig], // Save config with entry
                ambient: state.ambient.map(a => ({...a})),
                lifeTotal,
                total: getTotal(),
                pct: getPercentage(),
                threatLoad,
                opportunityLoad,
                neutralCount
            };
            
            state.entries.unshift(entry);
            
            // Send to Google Sheets
            fetch('https://script.google.com/macros/s/AKfycbyre8dXSoVH3LDvBa-SsfPjX0gpKbNcjrF7p-YLQB6fhkQQNRcxmFyoqhp-Xp45VlLU0Q/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(entry)
            }).then(() => {
                console.log('Data sent to Google Sheets');
            }).catch(error => {
                console.error('Error sending to Google Sheets:', error);
            });
            
            render();
        }

        function copyEntries() {
            const text = state.entries.map(e => {
                const date = new Date(e.timestamp).toLocaleString();
                
                // Use the saved config from the entry
                const config = e.lifeAreasConfig || state.lifeAreasConfig;
                const lifeAreasText = config.map(c => {
                    const value = -(e.lifeAreas[c.key] || 0);
                    return `${c.label}: ${value}`;
                }).join(', ');
                
                const ambientText = e.ambient.filter(a => a.value !== 0).map((a, i) => {
                    const typeLabels = {
                        'draining_positive': 'Positive/Draining',
                        'expansive_positive': 'Positive/Expansive',
                        'draining_negative': 'Negative/Draining',
                        'productive_negative': 'Negative/Productive'
                    };
                    return `  [${a.value}/15, ${typeLabels[a.type]}]: ${a.note}`;
                }).join('\n');
                return `=== ${date} ===
Life Areas (Net: ${e.lifeTotal}):
${lifeAreasText}

Internal Experiences:
${ambientText || '  (none)'}

Threat Load: ${e.threatLoad || 0}
Opportunity Load: ${e.opportunityLoad || 0}  
Neutral Count: ${e.neutralCount || 0}
Total Load: ${e.total} (${e.pct}%)\n`;
            }).join('\n');
            navigator.clipboard.writeText(text);
            alert('Entries copied!');
        }

        function clearEntries() {
            if (confirm('Clear all entries?')) {
                state.entries = [];
                render();
            }
        }

        function updateVisualization(threatLoad, opportunityLoad, neutralCount) {
            const visualization = document.getElementById('visualization');
            if (!visualization) return;
            
            const gateShapeTop = document.getElementById('gateShapeTop');
            const gateShapeBottom = document.getElementById('gateShapeBottom');
            const gateTextTop = document.getElementById('gateTextTop');
            const gateTextBottom = document.getElementById('gateTextBottom');
            const riverChannel = document.getElementById('riverChannel');
            const riverWater = document.getElementById('riverWater');
            const riverText = document.getElementById('riverText');
            
            const height = 300;
            const maxLoad = 50; // Max possible load on either end
            
            // Calculate raw gate heights - each can go up to 90%
            let topGateHeight = Math.min((threatLoad / maxLoad) * height * 1.8, height * 0.9);
            let bottomGateHeight = Math.min((opportunityLoad / maxLoad) * height * 1.8, height * 0.9);
            
            // Ensure combined gates never exceed 90% of total height
            const combinedHeight = topGateHeight + bottomGateHeight;
            const maxCombined = height * 0.9;
            
            if (combinedHeight > maxCombined) {
                // Scale both gates down proportionally
                const scaleFactor = maxCombined / combinedHeight;
                topGateHeight = topGateHeight * scaleFactor;
                bottomGateHeight = bottomGateHeight * scaleFactor;
            }
            
            gateShapeTop.style.height = topGateHeight + 'px';
            gateShapeBottom.style.height = bottomGateHeight + 'px';
            
            gateTextTop.style.top = topGateHeight + 'px';
            gateTextTop.textContent = 'THREAT\n' + threatLoad;
            
            gateTextBottom.style.bottom = bottomGateHeight + 'px';
            gateTextBottom.textContent = 'OPPORTUNITY\n' + opportunityLoad;
            
            // Calculate background color based on gate positions
            const availableSpace = height - topGateHeight - bottomGateHeight;
            const topGateFactor = topGateHeight / height;
            const bottomGateFactor = bottomGateHeight / height;
            
            let r, g, b;
            
            // Determine dominant influence
            if (topGateFactor > bottomGateFactor) {
                // Threat is dominant
                const threatIntensity = topGateFactor * 2.2;
                if (threatIntensity < 0.5) {
                    const factor = threatIntensity * 2;
                    r = Math.round(68 + (187 * factor));
                    g = Math.round(136 + (100 * factor));
                    b = Math.round(255 - (155 * factor));
                } else {
                    const factor = (threatIntensity - 0.5) * 2;
                    r = 255;
                    g = Math.round(236 - (136 * factor));
                    b = Math.round(100 - (100 * factor));
                }
            } else if (bottomGateFactor > topGateFactor) {
                // Opportunity is dominant
                const oppIntensity = bottomGateFactor * 2.2;
                const factor = Math.min(oppIntensity, 1);
                r = Math.round(68 - (0 * factor));
                g = Math.round(136 + (119 * factor));
                b = Math.round(255 - (187 * factor));
            } else {
                // Balanced
                r = 68;
                g = 136;
                b = 255;
            }
            
            visualization.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            
            // River channel
            const width = 600;
            const riverTop = topGateHeight;
            const riverBottom = height - bottomGateHeight;
            const riverHeight = riverBottom - riverTop;
            
            const spaceFactor = availableSpace / height;
            const maxChannelWidth = height * 0.5;
            const minChannelWidth = height * 0.08;
            
            let channelWidth = minChannelWidth + (spaceFactor * (maxChannelWidth - minChannelWidth));
            channelWidth = Math.min(channelWidth, riverHeight * 0.9);
            
            const waterWidth = channelWidth * 0.85;
            
            const channelTopY = riverTop + Math.max(0, (riverHeight - channelWidth) / 2);
            const channelBottomY = channelTopY + channelWidth;
            
            const channelPath = `M 0,${channelTopY} L ${width},${channelTopY} L ${width},${channelBottomY} L 0,${channelBottomY} Z`;
            
            const waterTopY = channelTopY + (channelWidth - waterWidth) / 2;
            const waterBottomY = waterTopY + waterWidth;
            const waterPath = `M 0,${waterTopY} L ${width},${waterTopY} L ${width},${waterBottomY} L 0,${waterBottomY} Z`;
            
            riverChannel.setAttribute('d', channelPath);
            riverWater.setAttribute('d', waterPath);
            
            const centerY = topGateHeight + (availableSpace / 2);
            riverText.style.top = centerY + 'px';
            
            const neutralList = document.getElementById('neutralList');
            if (neutralList) {
                neutralList.style.top = centerY + 'px';
            }
            
            const availablePercent = availableSpace / height;
            
            if (availablePercent < 0.3) {
                const fontSize = Math.max(8, availablePercent * 40);
                const letterSpacing = Math.max(0, (0.3 - availablePercent) * 10);
                riverText.style.fontSize = fontSize + 'px';
                riverText.style.letterSpacing = letterSpacing + 'px';
            } else {
                riverText.style.fontSize = '14px';
                riverText.style.letterSpacing = '0px';
            }
            
            updateContributorLists();
        }
        
        function updateContributorLists() {
            const contributorsThreat = document.getElementById('contributorsThreat');
            const contributorsOpportunity = document.getElementById('contributorsOpportunity');
            const neutralList = document.getElementById('neutralList');
            
            if (!contributorsThreat || !contributorsOpportunity || !neutralList) return;
            
            const typeLabels = {
                'draining_positive': 'Positive/Draining',
                'expansive_positive': 'Positive/Expansive',
                'draining_negative': 'Negative/Draining',
                'productive_negative': 'Negative/Productive'
            };
            
            let threatItems = [];
            let opportunityItems = [];
            let neutralItems = [];
            
            // Collect life area contributors
            state.lifeAreasConfig.forEach(config => {
                const value = state.lifeAreas[config.key];
                if (value > 0) {
                    threatItems.push({ label: config.label, value: value });
                } else if (value < 0) {
                    opportunityItems.push({ label: config.label, value: Math.abs(value) });
                } else {
                    neutralItems.push(config.label);
                }
            });
            
            // Collect internal experience contributors
            state.ambient.forEach((amb, i) => {
                if (amb.value !== 0) {
                    const typeLabel = typeLabels[amb.type] || amb.type;
                    const label = `Internal Experience ${i+1} (${typeLabel})`;
                    
                    if (amb.type === 'draining_positive' || amb.type === 'draining_negative') {
                        threatItems.push({ label: label, value: amb.value });
                    } else if (amb.type === 'expansive_positive' || amb.type === 'productive_negative') {
                        opportunityItems.push({ label: label, value: amb.value });
                    }
                }
            });
            
            threatItems.sort((a, b) => b.value - a.value);
            opportunityItems.sort((a, b) => b.value - a.value);
            
            contributorsThreat.innerHTML = threatItems.length > 0 
                ? threatItems.map(item => `<div class="contributor-item">${item.label}: ${item.value}</div>`).join('')
                : '';
            
            contributorsOpportunity.innerHTML = opportunityItems.length > 0
                ? opportunityItems.map(item => `<div class="contributor-item">${item.label}: ${item.value}</div>`).join('')
                : '';
            
            neutralList.innerHTML = neutralItems.length > 0
                ? '<div style="font-weight: bold; margin-bottom: 3px;">Neutral (0):</div>' + 
                  neutralItems.map(label => `<div class="neutral-item">‚Ä¢ ${label}</div>`).join('')
                : '';
        }

        function render() {
            const total = getTotal();
            const pct = getPercentage();
            const status = getStatus();
            const lifeTotal = -Object.values(state.lifeAreas).reduce((sum, val) => sum + val, 0);
            
            const threatLoad = getThreatLoad();
            const opportunityLoad = getOpportunityLoad();
            const neutralCount = getNeutralCount();

            const html = `
                <div class="card header">
                    <h1>Offload: A nervous system validation companion</h1>
                    <div class="subtitle">(Based on the concepts of Polyvagal Theory, Shadow Work, Window of Tolerance, Inner Child Work, and RAS and default mode reprogramming)<br><em style="font-size: 11px; color: #9333ea;">Saves to Google Sheets</em></div>
                </div>

                <div class="card section-blue">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 9px;">
                        <h2 style="margin: 0;">1. Current Life Areas (How big or small are your internal experiences, are they good, bad, or neutral?)</h2>
                        <button class="btn btn-toggle" onclick="toggleLifeAreasVisibility()">
                            ${state.lifeAreasVisible ? 'üëÅÔ∏è Hide' : 'üëÅÔ∏è Show'} Life Areas
                        </button>
                    </div>
                    
                    <div class="${state.lifeAreasVisible ? '' : 'hidden'}">
                        <div class="meta-layer">
                            <div class="meta-labels">
                                <div class="meta-label">Regulated Opportunity Responses</div>
                                <div class="meta-label">Neutral or Mixed</div>
                                <div class="meta-label">Dysregulated Threat Responses</div>
                            </div>
                            <div class="meta-lines">
                                <div class="meta-line meta-line-left"></div>
                                <div class="meta-line meta-line-right"></div>
                            </div>
                        </div>
                        
                        <div class="life-areas-container">
                            <div class="life-areas-dividers">
                                <div class="divider-line divider-left"></div>
                                <div class="divider-line divider-right"></div>
                            </div>
                        
                        ${state.lifeAreasConfig.map(config => `
                            <div class="slider-container">
                                <div class="slider-header">
                                    <span class="slider-label">${config.label}</span>
                                    <div class="slider-actions">
                                        <button class="icon-btn" onclick="openEditModal('${config.key}')" title="Edit">‚úèÔ∏è</button>
                                        <button class="icon-btn" onclick="deleteLifeArea('${config.key}')" title="Delete">üóëÔ∏è</button>
                                    </div>
                                    <span class="slider-value" style="color: ${getSliderColor(-state.lifeAreas[config.key])};">${-state.lifeAreas[config.key] > 0 ? '+' : ''}${-state.lifeAreas[config.key]}</span>
                                </div>
                                <div class="slider-labels"><span>${config.positiveLabel}</span><span>${config.neutralLabel}</span><span>${config.negativeLabel}</span></div>
                                <input type="range" min="-5" max="5" value="${state.lifeAreas[config.key]}" 
                                       onchange="updateSlider('life', '${config.key}', this.value)"
                                       style="background: linear-gradient(to right, #64ff64 0%, #4488ff 50%, #ffaa44 75%, #ff4444 100%);">
                            </div>
                        `).join('')}
                        
                        </div>
                        
                        ${state.lifeAreasConfig.length < 10 ? `
                            <button class="btn btn-add" onclick="openAddModal()">+ Add Life Area</button>
                        ` : ''}
                        
                        <div class="subtotal">
                            <div class="subtotal-text">Life Areas Net: ${lifeTotal} (negative = draining, positive = energizing)</div>
                        </div>
                    </div>
                    
                    ${!state.lifeAreasVisible ? `
                        <div class="subtotal">
                            <div class="subtotal-text">Life Areas Net: ${lifeTotal} (${state.lifeAreasConfig.length} areas configured)</div>
                        </div>
                    ` : ''}
                </div>

                <div class="card section-purple">
                    <h2>2. Specific Internal Experiences (Emotions, Vibes, Somatic/Bodily Activity) (0-15 each)</h2>
                    <div class="subtitle"><em>Rate and describe what you're carrying internally</em></div>
                    
                    <div class="examples-box">
                        <div class="examples-title">Could be positive or negative internal responses:</div>
                        <div class="examples-list">
                            <strong>Positive:</strong> Joy, calm, contentment, enthusiasm<br>
                            <strong>Negative/Threat responses:</strong> Fear, anger, tension, shutting down
                        </div>
                    </div>

                    ${state.ambient.map((amb, i) => `
                        <div class="slider-container">
                            <div class="slider-header">
                                <span class="slider-label">Internal Activity Intensity/Loudness ${i+1}</span>
                                <span class="slider-value" style="color: #9333ea;">${amb.value}</span>
                            </div>
                            <input type="range" min="0" max="15" value="${amb.value}" 
                                   onchange="updateAmbient(${i}, 'value', this.value)"
                                   style="background: #d1d5db;">
                            <div class="slider-labels"><span>0 Not present</span><span>15 Very present</span></div>
                            
                            ${amb.value !== 0 ? `
                                <label class="input-label">Type (required):</label>
                                <select onchange="updateAmbient(${i}, 'type', this.value)" 
                                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; margin-bottom: 6px;">
                                    <option value="draining_positive" ${amb.type === 'draining_positive' ? 'selected' : ''}>Positive but Draining/Obsessive</option>
                                    <option value="expansive_positive" ${amb.type === 'expansive_positive' ? 'selected' : ''}>Positive and Expansive/Calming</option>
                                    <option value="draining_negative" ${amb.type === 'draining_negative' ? 'selected' : ''}>Negative and Draining/Obsessive</option>
                                    <option value="productive_negative" ${amb.type === 'productive_negative' ? 'selected' : ''}>Negative with Positive Returns</option>
                                </select>
                                
                                <label class="input-label">Note (required):</label>
                                <textarea onchange="updateAmbient(${i}, 'note', this.value)"
                                          placeholder="Brief description or context...">${amb.note}</textarea>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>

                <div class="card" style="border: 2px solid #9333ea;">
                    <h2>System Load Summary</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 9px; margin: 12px 0;">
                        <div style="background: #fee2e2; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Threat Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">${threatLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Dysregulated</div>
                        </div>
                        <div style="background: #dbeafe; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Neutral Areas</div>
                            <div style="font-size: 28px; font-weight: bold; color: #3b82f6;">${neutralCount}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Regulated</div>
                        </div>
                        <div style="background: #d1fae5; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Opportunity Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${opportunityLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Enthusiasm/Fun</div>
                        </div>
                    </div>
                    <div class="status-box" style="background: ${status.color}; border-color: ${status.border}; color: ${status.textColor};">
                        <span class="status-icon">${status.icon}</span>
                        <span style="font-weight: 600;">${status.text}</span>
                    </div>
                </div>

                <div class="card">
                    <h2>Window of Tolerance Visualization</h2>
                    <div class="visualization" id="visualization">
                        <div class="color-legend"></div>
                        
                        <div class="zone-labels">
                            <div class="zone-label">Threat Response (Dysregulated):<br>Fear, anxiety, activated feel, anger,<br>hopelessness, powerlessness,<br>and threat of pain responses</div>
                            <div class="zone-label">Grounded, calm,<br>and approachable (Regulated)</div>
                            <div class="zone-label">Opportunity Responses:<br>Enthusiasm, joy, sex, hunger,<br>expansiveness or freedom feelings</div>
                        </div>

                        <svg viewBox="0 0 600 300" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#0088ff;stop-opacity:0.4" />
                                    <stop offset="100%" style="stop-color:#0088ff;stop-opacity:0.9" />
                                </linearGradient>
                            </defs>
                            <path id="riverChannel" class="river-channel" d=""/>
                            <path id="riverWater" class="river-water" d=""/>
                        </svg>

                        <div class="gate-top">
                            <div class="gate-shape-top" id="gateShapeTop">
                                <div class="gate-interior-top"></div>
                                <div class="gate-outline-top"></div>
                            </div>
                        </div>

                        <div class="gate-bottom">
                            <div class="gate-shape-bottom" id="gateShapeBottom">
                                <div class="gate-interior-bottom"></div>
                                <div class="gate-outline-bottom"></div>
                            </div>
                        </div>

                        <div class="gate-text-top" id="gateTextTop">THREAT<br>0</div>
                        <div class="gate-text-bottom" id="gateTextBottom">OPPORTUNITY<br>0</div>
                        <div class="river-text" id="riverText">Window of Tolerance Width<br>or Internal Information<br>Processing Capacity</div>
                        <div class="neutral-list" id="neutralList"></div>
                        
                        <div class="contributors-list contributors-threat" id="contributorsThreat"></div>
                        <div class="contributors-list contributors-opportunity" id="contributorsOpportunity"></div>

                        <div class="ground-label">Window of Tolerance<br>Threat: ${threatLoad} | Neutral: ${neutralCount} | Opportunity: ${opportunityLoad}</div>
                    </div>
                </div>

                <div class="card">
                    <h2>How This Works:</h2>
                    <div class="how-it-works">
                        <div class="how-item"><span class="how-label">Dual Gates System:</span> Top gate (red) closes down with threat load, bottom gate (green) closes up with opportunity load. Blue river flows between them showing your window of tolerance.</div>
                        <div class="how-item"><span class="how-label">Life Areas (+5 to -5 each):</span> Negative values (dysregulated) add to threat, positive values (enthusiasm/fun) add to opportunity. Zero is regulated/calm.</div>
                        <div class="how-item"><span class="how-label">Internal Experiences (0-15 each):</span> Rate intensity, then select type:
                            <ul style="margin-left: 20px; margin-top: 3px;">
                                <li><strong>Positive but Draining/Obsessive:</strong> Adds to threat (e.g., manic excitement)</li>
                                <li><strong>Positive and Expansive/Calming:</strong> Adds to opportunity (e.g., contentment, curiosity)</li>
                                <li><strong>Negative and Draining/Obsessive:</strong> Adds to threat (e.g., fear, rumination)</li>
                                <li><strong>Negative with Positive Returns:</strong> Adds to opportunity (e.g., productive grief)</li>
                            </ul>
                        </div>
                        <div class="how-item"><span class="how-label">Regulated State:</span> More zeros = wider blue river = more capacity available</div>
                        <div class="how-item"><span class="how-label">Customization:</span> Click edit (‚úèÔ∏è) to change life area labels, or delete (üóëÔ∏è) to remove. Add new life areas with the "+ Add Life Area" button (max 10 total).</div>
                    </div>
                </div>

                <div class="card" style="border: 2px solid #16a34a;">
                    <h2>üíæ Save Current Entry</h2>
                    <div class="subtitle" style="margin-bottom: 12px;">Save a timestamped snapshot of all current ratings to Google Sheets</div>
                    
                    ${state.saveError ? `<div class="error-message">${state.saveError}</div>` : ''}
                    
                    <button class="btn btn-success" onclick="saveEntry()">Save Entry</button>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 style="margin: 0;">Saved Entries: ${state.entries.length}</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" style="background: #3b82f6; color: white;" onclick="copyEntries()" ${state.entries.length === 0 ? 'disabled style="background: #d1d5db; cursor: not-allowed;"' : ''}>üìã Copy All</button>
                            <button class="btn" style="background: #dc2626; color: white;" onclick="clearEntries()" ${state.entries.length === 0 ? 'disabled style="background: #d1d5db; cursor: not-allowed;"' : ''}>üóëÔ∏è Clear All</button>
                        </div>
                    </div>
                    
                    ${state.entries.length === 0 ? '<div style="text-align: center; padding: 36px 0; color: #6b7280;">No saved entries yet</div>' : `
                        <div style="max-height: 450px; overflow-y: auto;">
                            ${state.entries.map(e => {
                                const config = e.lifeAreasConfig || state.lifeAreasConfig;
                                return `
                                <div class="entry-item">
                                    <div class="entry-timestamp">
                                        ${new Date(e.timestamp).toLocaleString()}
                                    </div>
                                    
                                    <div class="entry-section">
                                        <div class="entry-section-title">System Loads</div>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px;">
                                            <div style="background: #fee2e2; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Threat</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">${e.threatLoad || 0}</div>
                                            </div>
                                            <div style="background: #dbeafe; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Neutral</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #3b82f6;">${e.neutralCount || 0}</div>
                                            </div>
                                            <div style="background: #d1fae5; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Opportunity</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #16a34a;">${e.opportunityLoad || 0}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="entry-section">
                                        <div class="entry-section-title">Life Areas (Total: ${e.lifeTotal})</div>
                                        <div class="entry-life-areas">
                                            ${config.map(c => {
                                                const value = -(e.lifeAreas[c.key] || 0);
                                                return `<div>${c.label}: <strong>${value}</strong></div>`;
                                            }).join('')}
                                        </div>
                                    </div>

                                    <div class="entry-section">
                                        <div class="entry-section-title">Internal Experiences</div>
                                        ${e.ambient.filter(a => a.value !== 0).length === 0 ? 
                                            '<div style="font-style: italic; color: #6b7280; font-size: 12px;">No internal experiences recorded</div>' :
                                            e.ambient.filter(a => a.value !== 0).map((a, i) => {
                                                const typeLabels = {
                                                    'draining_positive': 'Positive/Draining',
                                                    'expansive_positive': 'Positive/Expansive',
                                                    'draining_negative': 'Negative/Draining',
                                                    'productive_negative': 'Negative/Productive'
                                                };
                                                return `
                                                <div class="entry-ambient">
                                                    <div class="entry-ambient-header">[${a.value}/15] - ${typeLabels[a.type] || a.type}</div>
                                                    <div class="entry-ambient-note">"${a.note}"</div>
                                                </div>
                                            `;
                                            }).join('')
                                        }
                                    </div>

                                    <div class="entry-total">
                                        Total Load: ${e.total} (${e.pct}%)
                                    </div>
                                </div>
                            `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;

            document.getElementById('app').innerHTML = html;
            
            setTimeout(() => updateVisualization(threatLoad, opportunityLoad, neutralCount), 0);
        }

        // Initialize and render
        initializeState();
        render();
    </script>
</body>
</html>
