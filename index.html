<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offload: A nervous system validation companion</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f9fafb;
            padding: 15px;
        }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 6px; padding: 18px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header { border-left: 4px solid #3b82f6; padding-left: 15px; }
        .section-blue { border-left: 4px solid #3b82f6; }
        .section-purple { border-left: 4px solid #9333ea; }
        h1 { font-size: 22px; margin-bottom: 6px; color: #111827; }
        h2 { font-size: 18px; margin-bottom: 9px; color: #111827; }
        .subtitle { color: #6b7280; font-size: 13px; margin-bottom: 12px; }
        .slider-container { background: #f9fafb; padding: 6px; border-radius: 4px; margin-bottom: 5px; }
        .slider-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px; }
        .slider-label { font-weight: 600; color: #111827; font-size: 14px; }
        .slider-value { font-size: 18px; font-weight: bold; }
        input[type="range"] { 
            width: 100%; 
            height: 6px; 
            border-radius: 3px; 
            outline: none; 
            -webkit-appearance: none;
            cursor: pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #333;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        input[type="text"], textarea { 
            width: 100%; 
            padding: 8px; 
            border: 1px solid #d1d5db; 
            border-radius: 4px; 
            font-size: 14px;
            font-family: inherit;
        }
        textarea { min-height: 50px; resize: vertical; }
        .input-label { font-size: 13px; font-weight: 600; color: #374151; margin-top: 6px; margin-bottom: 3px; display: block; }
        .slider-labels { display: flex; justify-content: space-between; font-size: 10px; color: #6b7280; margin-bottom: 2px; }
        .meta-layer { position: relative; height: 16px; margin-bottom: 4px; }
        .meta-lines { position: absolute; top: 0; left: 0; right: 0; height: 100%; display: flex; }
        .meta-line { position: absolute; top: 0; height: 100%; width: 1px; border-left: 2px dashed #9ca3af; }
        .meta-line-left { left: 33.33%; }
        .meta-line-right { left: 66.67%; }
        .meta-labels { display: flex; justify-content: space-between; font-size: 9px; color: #6b7280; font-style: italic; padding: 0 2px; }
        .meta-label { flex: 1; text-align: center; }
        .life-areas-container { position: relative; }
        .life-areas-dividers { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 1; }
        .divider-line { position: absolute; top: 0; bottom: 0; width: 1px; border-left: 2px dashed #d1d5db; opacity: 0.6; }
        .divider-left { left: 33.33%; }
        .divider-right { left: 66.67%; }
        .slider-marks-container { position: relative; }
        .slider-marks { display: flex; justify-content: space-between; align-items: flex-start; height: 10px; margin-top: 2px; }
        .slider-mark { flex: 1; display: flex; flex-direction: column; align-items: center; position: relative; }
        .slider-mark-number { font-size: 9px; color: #6b7280; margin-top: 1px; font-weight: 500; }
        .subtotal { background: #dbeafe; border: 2px solid #93c5fd; padding: 8px; border-radius: 4px; margin-top: 6px; }
        .subtotal-text { font-size: 14px; font-weight: bold; color: #111827; }
        .total-box { background: #fee2e2; border: 2px solid #fca5a5; padding: 18px; border-radius: 6px; text-align: center; margin-bottom: 12px; }
        .total-label { color: #6b7280; font-size: 13px; margin-bottom: 3px; }
        .total-value { font-size: 40px; font-weight: bold; color: #dc2626; margin-bottom: 6px; }
        .total-percent { font-size: 28px; font-weight: bold; color: #dc2626; }
        .status-box { padding: 12px; border-radius: 6px; border: 2px solid; display: flex; align-items: center; gap: 8px; }
        .status-icon { font-size: 20px; }
        .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-success { background: #16a34a; color: white; width: 100%; padding: 10px; font-size: 15px; }
        .btn-success:hover { background: #15803d; }
        .btn-success:disabled { background: #d1d5db; cursor: not-allowed; }
        
        .visualization {
            position: relative;
            width: 100%;
            height: 300px;
            border: 2px solid #333;
            border-radius: 5px;
            overflow: hidden;
            background: #44ff44;
            transition: background-color 0.3s ease-out;
        }

        .color-legend {
            position: absolute;
            left: 10px;
            top: 10px;
            bottom: 10px;
            width: 25px;
            background: linear-gradient(to bottom,
                #ff4444 0%,
                #ffaa44 33%,
                #4488ff 66%,
                #44ff44 100%
            );
            border: 2px solid #333;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 9;
        }

        .zone-labels {
            position: absolute;
            left: 45px;
            width: 180px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            pointer-events: none;
            z-index: 10;
        }

        .zone-label {
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 12px;
            padding: 4px;
            background: rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .visualization svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .river-channel {
            fill: rgba(135, 206, 250, 0.6);
            stroke: #4682b4;
            stroke-width: 2;
            transition: d 0.3s ease-out;
        }

        .river-water {
            fill: url(#waterGradient);
            opacity: 0.8;
            transition: d 0.3s ease-out;
        }

        .gate-top {
            position: absolute;
            left: 35%;
            top: 0;
            width: 100px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            z-index: 5;
            transform: translateX(-50%);
        }

        .gate-bottom {
            position: absolute;
            left: 35%;
            bottom: 0;
            width: 100px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            z-index: 5;
            transform: translateX(-50%);
        }

        .gate-shape-top {
            width: 100%;
            position: relative;
            transition: height 0.3s ease-out;
        }

        .gate-shape-bottom {
            width: 100%;
            position: relative;
            transition: height 0.3s ease-out;
        }

        .gate-interior-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 100%;
            background: rgba(255, 100, 100, 0.3);
            border-radius: 0 0 50% 50%;
            z-index: 1;
        }

        .gate-interior-bottom {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 100%;
            background: rgba(100, 255, 100, 0.3);
            border-radius: 50% 50% 0 0;
            z-index: 1;
        }

        .gate-outline-top {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            border: 4px solid #222;
            border-top: none;
            border-radius: 0 0 50% 50%;
            background: transparent;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            z-index: 2;
        }

        .gate-outline-bottom {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            border: 4px solid #222;
            border-bottom: none;
            border-radius: 50% 50% 0 0;
            background: transparent;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            z-index: 2;
        }

        .gate-text-top {
            position: absolute;
            left: 35%;
            transform: translateX(-50%);
            top: 0;
            color: white;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            z-index: 6;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            transition: top 0.3s ease-out;
            pointer-events: none;
        }

        .gate-text-bottom {
            position: absolute;
            left: 35%;
            transform: translateX(-50%);
            bottom: 0;
            color: white;
            font-weight: bold;
            font-size: 13px;
            text-align: center;
            z-index: 6;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
            transition: bottom 0.3s ease-out;
            pointer-events: none;
        }

        .river-text {
            position: absolute;
            left: 45%;
            right: auto;
            width: 200px;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            z-index: 6;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            pointer-events: none;
            transition: top 0.3s ease-out, font-size 0.3s ease-out, letter-spacing 0.3s ease-out;
            transform: translateY(-50%);
            white-space: normal;
            line-height: 1.2;
        }
        
        .neutral-list {
            position: absolute;
            left: 80%;
            color: white;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 6;
            pointer-events: none;
            transition: top 0.3s ease-out;
            transform: translateY(-50%);
            max-width: 250px;
        }
        
        .neutral-item {
            margin-bottom: 2px;
            line-height: 1.3;
        }

        .ground-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            z-index: 15;
        }
        
        .contributors-list {
            position: absolute;
            right: 40px;
            color: white;
            font-size: 11px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            z-index: 6;
            pointer-events: none;
            max-width: 300px;
        }
        
        .contributors-threat {
            top: 10px;
        }
        
        .contributors-opportunity {
            bottom: 10px;
        }
        
        .contributor-item {
            margin-bottom: 2px;
            line-height: 1.3;
        }
        
        .how-it-works { margin-top: 12px; }
        .how-item { margin-bottom: 9px; color: #374151; font-size: 13px; }
        .how-label { font-weight: 600; }
        .examples-box { 
            background: #f3f4f6; 
            border: 2px solid #d1d5db; 
            padding: 12px; 
            border-radius: 6px; 
            margin-bottom: 15px;
        }
        .examples-title { 
            font-weight: 700; 
            color: #111827; 
            margin-bottom: 6px; 
            font-size: 14px;
        }
        .examples-list { 
            font-size: 13px; 
            color: #374151; 
            line-height: 1.5;
        }
        .entry-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .entry-timestamp {
            font-size: 13px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 9px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e5e7eb;
        }
        .entry-section {
            margin-bottom: 9px;
        }
        .entry-section-title {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .entry-life-areas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 12px;
            color: #374151;
        }
        .entry-ambient {
            background: #f3f4f6;
            padding: 8px;
            border-radius: 5px;
            margin-bottom: 6px;
        }
        .entry-ambient-header {
            font-weight: 600;
            color: #111827;
            margin-bottom: 3px;
            font-size: 13px;
        }
        .entry-ambient-note {
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
            margin-top: 3px;
        }
        .entry-total {
            background: #fee2e2;
            padding: 9px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            color: #dc2626;
            font-size: 15px;
        }
        .error-message {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #991b1b;
            padding: 10px;
            border-radius: 5px;
            margin-top: 9px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="container" id="app"></div>

    <script>
        const state = {
            lifeAreas: { 
                mental: { value: 0, locked: true, interacted: false },
                spiritual: { value: 0, locked: true, interacted: false },
                somaticBody: { value: 0, locked: true, interacted: false }, 
                emotional: { value: 0, locked: true, interacted: false }, 
                workMoney: { value: 0, locked: true, interacted: false },
                moneyHandling: { value: 0, locked: true, interacted: false },
                housingComforts: { value: 0, locked: true, interacted: false }, 
                freedomLevel: { value: 0, locked: true, interacted: false }
            },
            ambient: [
                { id: Date.now(), value: 0, type: 'regulated', note: '', locked: false }
            ],
            entries: [],
            saveError: '',
            section2DescExpanded: false,
            section2DescText: localStorage.getItem('offload_section2_desc') || `Three types of internal responses:

THREAT RESPONSE (DYSREGULATED): Fear, anxiety, activated feel, anger, hopelessness, powerlessness, and threat of pain responses

GROUNDED, CALM, AND APPROACHABLE (REGULATED): Present-moment awareness, body connection, gentle contentment, stable calm

OPPORTUNITY RESPONSES: Enthusiasm, joy, sex, hunger, expansiveness or freedom feelings

---

You can add more detailed descriptions here. This text will be saved automatically.`
        };

        function toggleSection2Desc() {
            state.section2DescExpanded = !state.section2DescExpanded;
            render();
        }

        function updateSection2Desc(text) {
            state.section2DescText = text;
            localStorage.setItem('offload_section2_desc', text);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        function getLifeAreaDisplayValue(internalValue) {
            // Convert internal -7 to +7 scale to display labels
            if (internalValue === 0) return '00';
            if (internalValue === -1) return '+0';
            if (internalValue === 1) return '-0';
            if (internalValue < -1) return '+' + Math.abs(internalValue + 1); // -7 to -2 becomes +5 to +1
            if (internalValue > 1) return '-' + (internalValue - 1); // +7 to +2 becomes -5 to -1
            return '00';
        }

        function getSliderColor(value) {
            // Value comes in negated for display
            if (value > 0) {
                // Green gradient: lighter at +1, darker at +5 (energizing)
                const intensity = value / 5; // 0.2 to 1.0
                const red = Math.round(100 - (100 * intensity)); // 100 to 0
                const green = Math.round(220 + (35 * intensity)); // 220 to 255
                const blue = Math.round(100 - (100 * intensity)); // 100 to 0
                return `rgb(${red}, ${green}, ${blue})`;
            } else if (value < 0) {
                const absValue = Math.abs(value);
                if (absValue <= 1.5) {
                    // Transition from blue to yellow/orange (0 to -1.5)
                    const intensity = absValue / 1.5; // 0 to 1
                    const red = Math.round(68 + (200 * intensity)); // 68 to 268 -> capped at 255
                    const green = Math.round(136 + (100 * intensity)); // 136 to 236
                    const blue = Math.round(255 - (155 * intensity)); // 255 to 100
                    return `rgb(${Math.min(red, 255)}, ${Math.min(green, 255)}, ${blue})`;
                } else {
                    // Yellow/orange to red gradient (-1.5 to -5)
                    const intensity = (absValue - 1.5) / 3.5; // 0 to 1
                    const red = 255; // Stay at max red
                    const green = Math.round(236 - (136 * intensity)); // 236 to 100
                    const blue = Math.round(100 - (100 * intensity)); // 100 to 0
                    return `rgb(${red}, ${green}, ${blue})`;
                }
            } else {
                return 'rgb(68, 136, 255)'; // Blue for 0
            }
        }

        function toggleLifeAreaLock(key) {
            state.lifeAreas[key].locked = !state.lifeAreas[key].locked;
            render();
        }

        function addAmbientSlider() {
            if (state.ambient.length >= 6) return;
            state.ambient.push({
                id: Date.now(),
                value: 0,
                type: 'regulated',
                note: '',
                locked: false
            });
            render();
        }

        function toggleAmbientLock(id) {
            const amb = state.ambient.find(a => a.id === id);
            if (amb) {
                amb.locked = !amb.locked;
                render();
            }
        }

        function deleteAmbientSlider(id) {
            if (state.ambient.length <= 1) {
                alert('Must keep at least one internal experience slider');
                return;
            }
            if (confirm('Delete this internal experience?')) {
                state.ambient = state.ambient.filter(a => a.id !== id);
                render();
            }
        }

        function getAmbientSliderGradient(type, value) {
            // Returns a CSS gradient based on the type and value
            if (type === 'threat') {
                // Yellow â†’ Orange â†’ Red (0 to 10)
                return 'linear-gradient(to right, #ffeb3b 0%, #ff9800 50%, #f44336 100%)';
            } else if (type === 'regulated') {
                // Light blue â†’ Deep blue (0 to 10)
                return 'linear-gradient(to right, #bbdefb 0%, #1976d2 100%)';
            } else if (type === 'opportunity') {
                // Light hazy green â†’ Green â†’ Yellow (0 to 10)
                return 'linear-gradient(to right, #c8e6c9 0%, #4caf50 50%, #cddc39 100%)';
            }
            return 'linear-gradient(to right, #d1d5db 0%, #d1d5db 100%)';
        }

        function getTotal() {
            let lifeTotal = 0;
            let lifeRegulatedContribution = 0;
            
            // Process life areas with new scale - only if interacted
            Object.values(state.lifeAreas).forEach(area => {
                if (!area.interacted) return; // Skip non-interacted sliders
                
                const val = area.value;
                if (val === 0) {
                    // 00 (true center) = 0 contribution (neutral/inactive)
                    // Do nothing
                } else if (val === -1 || val === 1) {
                    // 0 (one step either way) adds +1 to regulated
                    lifeRegulatedContribution += 1;
                } else if (val < -1) {
                    // Opportunity side: -7 to -2 becomes actual values +5 to +1
                    const actualValue = Math.abs(val + 1);
                    lifeTotal += actualValue; // Positive contribution (opportunity)
                } else if (val > 1) {
                    // Threat side: +7 to +2 becomes actual values -5 to -1
                    const actualValue = -(val - 1);
                    lifeTotal += actualValue; // Negative contribution (threat)
                }
            });
            
            // Calculate ambient contribution based on type
            let ambientContribution = 0;
            state.ambient.forEach(amb => {
                if (amb.value !== 0) {
                    if (amb.type === 'threat') {
                        ambientContribution -= amb.value;
                    } else if (amb.type === 'opportunity') {
                        ambientContribution += amb.value;
                    } else if (amb.type === 'regulated') {
                        ambientContribution += amb.value;
                    }
                }
            });
            
            // Add life area regulated contribution to ambient
            ambientContribution += lifeRegulatedContribution;
            
            return lifeTotal + ambientContribution;
        }

        function getThreatLoad() {
            // Sum all threat values
            let threatTotal = 0;
            let lifeAreaThreat = 0;
            let ambientThreat = 0;
            
            Object.values(state.lifeAreas).forEach(area => {
                if (!area.interacted) return; // Skip non-interacted sliders
                
                const val = area.value;
                if (val > 1) {
                    // Threat side: +7 to +2 becomes actual values 5 to 1
                    lifeAreaThreat += (val - 1);
                }
            });
            
            // Add threat ambient experiences
            state.ambient.forEach(amb => {
                if (amb.value !== 0 && amb.type === 'threat') {
                    ambientThreat += amb.value;
                }
            });
            
            threatTotal = lifeAreaThreat + ambientThreat;
            console.log('Threat Load - Life:', lifeAreaThreat, 'Ambient:', ambientThreat, 'Total:', threatTotal);
            return threatTotal;
        }

        function getOpportunityLoad() {
            // Sum all opportunity values
            let opportunityTotal = 0;
            let lifeAreaOpp = 0;
            let ambientOpp = 0;
            
            Object.values(state.lifeAreas).forEach(area => {
                if (!area.interacted) return; // Skip non-interacted sliders
                
                const val = area.value;
                if (val < -1) {
                    // Opportunity side: -7 to -2 becomes actual values 5 to 1
                    lifeAreaOpp += Math.abs(val + 1);
                }
            });
            
            // Add opportunity ambient experiences
            state.ambient.forEach(amb => {
                if (amb.value !== 0 && amb.type === 'opportunity') {
                    ambientOpp += amb.value;
                }
            });
            
            opportunityTotal = lifeAreaOpp + ambientOpp;
            console.log('Opportunity Load - Life:', lifeAreaOpp, 'Ambient:', ambientOpp, 'Total:', opportunityTotal);
            return opportunityTotal;
        }

        function getRegulatedLoad() {
            // Sum all regulated values (from ambient AND from life areas at 0)
            let regulatedTotal = 0;
            
            // Life areas contribution - only if interacted
            Object.values(state.lifeAreas).forEach(area => {
                if (!area.interacted) return; // Skip non-interacted sliders
                
                const val = area.value;
                if (val === 0) {
                    // 00 = 0 contribution (neutral/inactive)
                    // Do nothing
                } else if (val === -1 || val === 1) {
                    regulatedTotal += 1; // 0 adds +1
                }
            });
            
            // Ambient contribution
            state.ambient.forEach(amb => {
                if (amb.value !== 0 && amb.type === 'regulated') {
                    regulatedTotal += amb.value;
                }
            });
            
            console.log('Regulated Load:', regulatedTotal);
            return regulatedTotal;
        }

        function getPercentage() {
            const total = getTotal();
            // Map -30 (max load) to 100%, +10 (min load) to 0%
            // Range is 40 total: from -30 to +10
            const normalized = (-total + 10) / 40; // Convert to 0-1 range (flip sign so -30 maps to 1)
            return Math.round(Math.max(0, Math.min(100, normalized * 100)));
        }

        function getStatus() {
            const pct = getPercentage();
            if (pct >= 90) return { icon: 'ðŸš¨', text: 'Critical load - system at capacity', color: '#fee2e2', border: '#fca5a5', textColor: '#991b1b' };
            if (pct >= 75) return { icon: 'âš ï¸', text: 'High load - approaching capacity', color: '#fed7aa', border: '#fb923c', textColor: '#9a3412' };
            if (pct >= 50) return { icon: 'âš¡', text: 'Moderate load - monitoring needed', color: '#fef3c7', border: '#fcd34d', textColor: '#92400e' };
            return { icon: 'âœ“', text: 'Expanded Tolerance - recovering or possible engagement', color: '#d1fae5', border: '#6ee7b7', textColor: '#065f46' };
        }

        function updateSlider(category, key, value) {
            if (category === 'life') {
                if (!state.lifeAreas[key].locked) {
                    state.lifeAreas[key].value = parseInt(value);
                    state.lifeAreas[key].interacted = true;
                    render();
                }
            }
        }

        function updateAmbient(id, field, value) {
            const amb = state.ambient.find(a => a.id === id);
            if (!amb || amb.locked) return;
            
            if (field === 'value') {
                amb.value = parseInt(value);
            } else {
                amb[field] = value;
            }
            render();
        }

        function validateSave() {
            const errors = [];
            state.ambient.forEach((amb, i) => {
                if (amb.value !== 0) {
                    if (!amb.type) errors.push(`Internal Activity ${i+1}: Type is required when slider is not at 0`);
                    if (!amb.note.trim()) errors.push(`Internal Activity ${i+1}: Note is required when slider is not at 0`);
                }
            });
            return errors;
        }

        function saveEntry() {
            const errors = validateSave();
            if (errors.length > 0) {
                state.saveError = errors.join('<br>');
                render();
                return;
            }

            state.saveError = '';
            
            // Extract display values for saving
            const lifeAreasDisplay = {};
            Object.keys(state.lifeAreas).forEach(key => {
                lifeAreasDisplay[key] = getLifeAreaDisplayValue(state.lifeAreas[key].value);
            });
            
            // Calculate life total based on actual threat/opportunity contributions
            let lifeTotal = 0;
            Object.values(state.lifeAreas).forEach(area => {
                const val = area.value;
                if (val < -1) {
                    lifeTotal += Math.abs(val + 1); // Opportunity
                } else if (val > 1) {
                    lifeTotal -= (val - 1); // Threat
                }
                // 00 and 0 don't contribute to lifeTotal, they go to regulated
            });
            
            const threatLoad = getThreatLoad();
            const opportunityLoad = getOpportunityLoad();
            const regulatedLoad = getRegulatedLoad();
            
            const entry = {
                timestamp: new Date().toISOString(),
                lifeAreas: {...lifeAreasDisplay},
                ambient: state.ambient.map(a => ({
                    value: a.value,
                    type: a.type,
                    note: a.note
                })),
                lifeTotal,
                total: getTotal(),
                pct: getPercentage(),
                threatLoad,
                opportunityLoad,
                regulatedLoad
            };
            
            state.entries.unshift(entry);
            
            // Send to Google Sheets
            fetch('https://script.google.com/macros/s/AKfycbyre8dXSoVH3LDvBa-SsfPjX0gpKbNcjrF7p-YLQB6fhkQQNRcxmFyoqhp-Xp45VlLU0Q/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(entry)
            }).then(() => {
                console.log('Data sent to Google Sheets');
            }).catch(error => {
                console.error('Error sending to Google Sheets:', error);
            });
            
            render();
        }

        function copyEntries() {
            const text = state.entries.map(e => {
                const date = new Date(e.timestamp).toLocaleString();
                const lifeAreasText = Object.entries(e.lifeAreas).map(([key, val]) => {
                    const labels = {
                        mental: 'Mental',
                        somaticBody: 'Somatic/Body',
                        emotional: 'Emotional',
                        housingComforts: 'Housing/Comforts',
                        workMoney: 'Work/Income',
                        moneyHandling: 'Money/Resources',
                        spiritual: 'Perception of Mankind',
                        freedomLevel: 'Friendly Universe'
                    };
                    return `${labels[key]}: ${val}`;
                }).join(', ');
                
                const ambientText = e.ambient.filter(a => a.value !== 0).map((a, i) => {
                    const typeLabels = {
                        'threat': 'Threat Response',
                        'regulated': 'Regulated/Grounded',
                        'opportunity': 'Opportunity Response'
                    };
                    return `  [${a.value}/10, ${typeLabels[a.type]}]: ${a.note}`;
                }).join('\n');
                return `=== ${date} ===
Life Areas (Net: ${e.lifeTotal}):
${lifeAreasText}

Internal Experiences:
${ambientText || '  (none)'}

Threat Load: ${e.threatLoad || 0}
Regulated Load: ${e.regulatedLoad || 0}
Opportunity Load: ${e.opportunityLoad || 0}
Total Load: ${e.total} (${e.pct}%)\n`;
            }).join('\n');
            navigator.clipboard.writeText(text);
            alert('Entries copied!');
        }

        function clearEntries() {
            if (confirm('Clear all entries?')) {
                state.entries = [];
                render();
            }
        }

        function updateVisualization(threatLoad, opportunityLoad, regulatedLoad) {
            const visualization = document.getElementById('visualization');
            if (!visualization) return;
            
            const gateShapeTop = document.getElementById('gateShapeTop');
            const gateShapeBottom = document.getElementById('gateShapeBottom');
            const gateTextTop = document.getElementById('gateTextTop');
            const gateTextBottom = document.getElementById('gateTextBottom');
            const riverChannel = document.getElementById('riverChannel');
            const riverWater = document.getElementById('riverWater');
            const riverText = document.getElementById('riverText');
            
            const height = 300;
            const maxLoad = 50; // Max possible load on either end
            
            // Calculate raw gate heights - each can go up to 90%
            let topGateHeight = Math.min((threatLoad / maxLoad) * height * 1.8, height * 0.9);
            let bottomGateHeight = Math.min((opportunityLoad / maxLoad) * height * 1.8, height * 0.9);
            
            // Ensure combined gates never exceed 90% of total height
            const combinedHeight = topGateHeight + bottomGateHeight;
            const maxCombined = height * 0.9;
            
            if (combinedHeight > maxCombined) {
                // Scale both gates down proportionally
                const scaleFactor = maxCombined / combinedHeight;
                topGateHeight = topGateHeight * scaleFactor;
                bottomGateHeight = bottomGateHeight * scaleFactor;
            }
            
            gateShapeTop.style.height = topGateHeight + 'px';
            gateShapeBottom.style.height = bottomGateHeight + 'px';
            
            gateTextTop.style.top = topGateHeight + 'px';
            gateTextTop.textContent = 'THREAT\n' + threatLoad;
            
            gateTextBottom.style.bottom = bottomGateHeight + 'px';
            gateTextBottom.textContent = 'OPPORTUNITY\n' + opportunityLoad;
            
            // Calculate background color based on gate positions
            // Regulated load widens the blue river space
            const availableSpace = height - topGateHeight - bottomGateHeight;
            const topGateFactor = topGateHeight / height; // 0 to 0.48
            const bottomGateFactor = bottomGateHeight / height; // 0 to 0.48
            const regulatedFactor = regulatedLoad / 30; // 0 to 1 (assuming max regulated is 30)
            
            let r, g, b;
            
            // If there's significant regulated load, bias toward blue
            if (regulatedFactor > 0.2) {
                // More regulated = more blue, less responsive to gates
                const blueIntensity = Math.min(regulatedFactor * 1.5, 1); // 0 to 1
                r = Math.round(68 + ((1 - blueIntensity) * 50));
                g = Math.round(136 + ((1 - blueIntensity) * 50));
                b = Math.round(255);
            } else if (topGateFactor > bottomGateFactor) {
                // Threat is dominant - blend from blue toward red/yellow
                const threatIntensity = topGateFactor * 2.2; // Amplify (0 to ~1)
                if (threatIntensity < 0.5) {
                    // Blue to yellow transition
                    const factor = threatIntensity * 2;
                    r = Math.round(68 + (187 * factor)); // 68 to 255
                    g = Math.round(136 + (100 * factor)); // 136 to 236
                    b = Math.round(255 - (155 * factor)); // 255 to 100
                } else {
                    // Yellow to red transition
                    const factor = (threatIntensity - 0.5) * 2;
                    r = 255;
                    g = Math.round(236 - (136 * factor)); // 236 to 100
                    b = Math.round(100 - (100 * factor)); // 100 to 0
                }
            } else if (bottomGateFactor > topGateFactor) {
                // Opportunity is dominant - blend from blue toward green
                const oppIntensity = bottomGateFactor * 2.2; // Amplify (0 to ~1)
                const factor = Math.min(oppIntensity, 1);
                r = Math.round(68 - (0 * factor)); // Stay at 68
                g = Math.round(136 + (119 * factor)); // 136 to 255
                b = Math.round(255 - (187 * factor)); // 255 to 68
            } else {
                // Balanced or both low - stay blue
                r = 68;
                g = 136;
                b = 255;
            }
            
            visualization.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
            
            // River channel flows through available space between gates
            // Regulated load makes the river wider
            const width = 600;
            const riverTop = topGateHeight;
            const riverBottom = height - bottomGateHeight;
            const riverHeight = riverBottom - riverTop;
            
            // Calculate channel width with regulated load bonus
            const spaceFactor = availableSpace / height;
            const maxChannelWidth = height * 0.5;
            const minChannelWidth = height * 0.08;
            
            // Base channel width
            let channelWidth = minChannelWidth + (spaceFactor * (maxChannelWidth - minChannelWidth));
            
            // Add regulated bonus - up to 20% wider
            const regulatedBonus = regulatedFactor * (height * 0.2);
            channelWidth = Math.min(channelWidth + regulatedBonus, riverHeight * 0.95);
            
            const waterWidth = channelWidth * 0.85;
            
            // Center the channel in the available space between gates
            const channelTopY = riverTop + Math.max(0, (riverHeight - channelWidth) / 2);
            const channelBottomY = channelTopY + channelWidth;
            
            const channelPath = `M 0,${channelTopY} L ${width},${channelTopY} L ${width},${channelBottomY} L 0,${channelBottomY} Z`;
            
            const waterTopY = channelTopY + (channelWidth - waterWidth) / 2;
            const waterBottomY = waterTopY + waterWidth;
            const waterPath = `M 0,${waterTopY} L ${width},${waterTopY} L ${width},${waterBottomY} L 0,${waterBottomY} Z`;
            
            riverChannel.setAttribute('d', channelPath);
            riverWater.setAttribute('d', waterPath);
            
            // Position river text in the center of the available space between gates
            const centerY = topGateHeight + (availableSpace / 2);
            riverText.style.top = centerY + 'px';
            
            // Update text to show regulated contribution
            if (regulatedLoad > 0) {
                riverText.innerHTML = `Window of Tolerance Width<br>or Internal Information<br>Processing Capacity<br><span style="font-size: 11px; color: #bbdefb;">(+${regulatedLoad} regulated)</span>`;
            } else {
                riverText.innerHTML = 'Window of Tolerance Width<br>or Internal Information<br>Processing Capacity';
            }
            
            // Position neutral list at same vertical center
            const neutralList = document.getElementById('neutralList');
            if (neutralList) {
                neutralList.style.top = centerY + 'px';
            }
            
            // Adjust font size and letter spacing based on available vertical space
            const availablePercent = availableSpace / height;
            
            if (availablePercent < 0.3) {
                const fontSize = Math.max(8, availablePercent * 40);
                const letterSpacing = Math.max(0, (0.3 - availablePercent) * 10);
                riverText.style.fontSize = fontSize + 'px';
                riverText.style.letterSpacing = letterSpacing + 'px';
            } else {
                riverText.style.fontSize = '14px';
                riverText.style.letterSpacing = '0px';
            }
            
            // Update contributor lists
            updateContributorLists();
        }
        
        function updateContributorLists() {
            const contributorsThreat = document.getElementById('contributorsThreat');
            const contributorsOpportunity = document.getElementById('contributorsOpportunity');
            const neutralList = document.getElementById('neutralList');
            
            if (!contributorsThreat || !contributorsOpportunity || !neutralList) return;
            
            const lifeAreasLabels = {
                mental: 'Mental Activity',
                somaticBody: 'Somatic &/or Body',
                emotional: 'Emotional',
                housingComforts: 'Housing & Creature Comforts',
                workMoney: 'Work Experiences & Income Generation',
                moneyHandling: 'Money & Resource Handling',
                spiritual: 'Personal Relationships or Interactions',
                freedomLevel: 'Spiritual Level Outlook'
            };
            
            const typeLabels = {
                'threat': 'Threat Response',
                'regulated': 'Regulated/Grounded',
                'opportunity': 'Opportunity Response'
            };
            
            let threatItems = [];
            let opportunityItems = [];
            let regulatedItems = [];
            
            // Collect life area contributors - only if interacted
            Object.entries(state.lifeAreas).forEach(([key, area]) => {
                if (!area.interacted) return; // Skip non-interacted sliders
                
                const val = area.value;
                if (val > 1) {
                    // Threat side
                    threatItems.push({ label: lifeAreasLabels[key], value: val - 1 });
                } else if (val < -1) {
                    // Opportunity side
                    opportunityItems.push({ label: lifeAreasLabels[key], value: Math.abs(val + 1) });
                } else if (val === -1 || val === 1) {
                    // 0 = +1 regulated
                    regulatedItems.push({ label: lifeAreasLabels[key], value: 1 });
                }
                // 00 (val === 0) contributes nothing
            });
            
            // Collect internal experience contributors
            state.ambient.forEach((amb, i) => {
                if (amb.value !== 0) {
                    const typeLabel = typeLabels[amb.type] || amb.type;
                    const label = `Internal Experience ${i+1} (${typeLabel})`;
                    
                    if (amb.type === 'threat') {
                        threatItems.push({ label: label, value: amb.value });
                    } else if (amb.type === 'opportunity') {
                        opportunityItems.push({ label: label, value: amb.value });
                    } else if (amb.type === 'regulated') {
                        regulatedItems.push({ label: label, value: amb.value });
                    }
                }
            });
            
            // Sort by value descending
            threatItems.sort((a, b) => b.value - a.value);
            opportunityItems.sort((a, b) => b.value - a.value);
            regulatedItems.sort((a, b) => b.value - a.value);
            
            // Render threat list
            contributorsThreat.innerHTML = threatItems.length > 0 
                ? threatItems.map(item => `<div class="contributor-item">${item.label}: ${item.value}</div>`).join('')
                : '';
            
            // Render opportunity list
            contributorsOpportunity.innerHTML = opportunityItems.length > 0
                ? opportunityItems.map(item => `<div class="contributor-item">${item.label}: ${item.value}</div>`).join('')
                : '';
            
            // Render regulated list
            let regulatedContent = '';
            if (regulatedItems.length > 0) {
                regulatedContent = '<div style="font-weight: bold; margin-bottom: 3px; color: #bbdefb;">Regulated:</div>' +
                  regulatedItems.map(item => `<div class="neutral-item" style="color: #bbdefb;">â€¢ ${item.label}: ${item.value}</div>`).join('');
            }
            neutralList.innerHTML = regulatedContent;
        }

        function render() {
            const total = getTotal();
            const pct = getPercentage();
            const status = getStatus();
            
            // Calculate life total for display
            let lifeTotal = 0;
            Object.values(state.lifeAreas).forEach(area => {
                if (!area.interacted) return; // Skip non-interacted sliders
                
                const val = area.value;
                if (val < -1) {
                    lifeTotal += Math.abs(val + 1); // Opportunity
                } else if (val > 1) {
                    lifeTotal -= (val - 1); // Threat
                }
            });
            
            const threatLoad = getThreatLoad();
            const opportunityLoad = getOpportunityLoad();
            const regulatedLoad = getRegulatedLoad();

            const lifeAreasConfig = [
                { key: 'mental', label: 'Mental Activity' },
                { key: 'somaticBody', label: 'Somatic &/or Body' },
                { key: 'emotional', label: 'Emotional' },
                { key: 'housingComforts', label: 'Housing & Creature Comforts' },
                { key: 'workMoney', label: 'Work Experiences & Income Generation' },
                { key: 'moneyHandling', label: 'Money & Resource Handling' },
                { key: 'spiritual', label: 'Personal Relationships or Interactions' },
                { key: 'freedomLevel', label: 'Spiritual Level Outlook' }
            ];

            const html = `
                <div class="card header">
                    <h1>Offload: A nervous system validation companion</h1>
                    <div class="subtitle">(Based on the concepts of Polyvagal Theory, Shadow Work, Window of Tolerance, Inner Child Work, and RAS and default mode reprogramming)<br><em style="font-size: 11px; color: #9333ea;">Saves to Google Sheets</em></div>
                </div>

                <div class="card">
                    <h2>How This Works:</h2>
                    <div class="how-it-works">
                        <div class="how-item"><span class="how-label">Dual Gates System:</span> Top gate (red) closes down with threat load, bottom gate (green) closes up with opportunity load. Blue river flows between them showing your window of tolerance.</div>
                        <div class="how-item"><span class="how-label">Life Areas (00, 0, 1-5 each):</span> Start at 00 (inactive). Unlock to adjust. 0 positions add +1 to regulated. Negative values (threat) close top gate, positive values (opportunity) close bottom gate.</div>
                        <div class="how-item"><span class="how-label">Internal Experiences (0-10 each):</span> Rate intensity, then select type:
                            <ul style="margin-left: 20px; margin-top: 3px;">
                                <li><strong>Threat Response (Dysregulated):</strong> Adds to threat gate (yellowâ†’orangeâ†’red gradient)</li>
                                <li><strong>Grounded, calm, and approachable (Regulated):</strong> Widens the blue river / window of tolerance (light blueâ†’deep blue gradient)</li>
                                <li><strong>Opportunity Responses:</strong> Adds to opportunity gate (light greenâ†’greenâ†’yellow gradient)</li>
                            </ul>
                        </div>
                        <div class="how-item"><span class="how-label">Regulated State:</span> More 0 positions + regulated load = wider blue river = more capacity available</div>
                    </div>
                </div>

                <div class="card section-blue">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 9px;">
                        <h2 style="margin: 0;">1. Current Life Areas (How big or small are your internal experiences, are they good, bad, or neutral?)</h2>
                    </div>
                    
                    <div class="meta-layer">
                        <div class="meta-labels">
                            <div class="meta-label">Regulated Opportunity Responses</div>
                            <div class="meta-label">Neutral or Mixed</div>
                            <div class="meta-label">Dysregulated Threat Responses</div>
                        </div>
                        <div class="meta-lines">
                            <div class="meta-line meta-line-left"></div>
                            <div class="meta-line meta-line-right"></div>
                        </div>
                    </div>
                    
                    <div class="life-areas-container">
                        <div class="life-areas-dividers">
                            <div class="divider-line divider-left"></div>
                            <div class="divider-line divider-right"></div>
                        </div>
                    
                    ${lifeAreasConfig.map(({ key, label }) => {
                        const area = state.lifeAreas[key];
                        const isMental = key === 'mental';
                        const isSomatic = key === 'somaticBody';
                        const isHousing = key === 'housingComforts';
                        const isWorkMoney = key === 'workMoney';
                        const isMoneyHandling = key === 'moneyHandling';
                        const isSpiritual = key === 'spiritual';
                        const isFreedomLevel = key === 'freedomLevel';
                        
                        let positiveLabel, neutralLabel, negativeLabel;
                        
                        if (isMental) {
                            positiveLabel = '+5 Creative, Pleasant, Enjoyable (beware overly fantasizing)';
                            neutralLabel = '0 Think about self compassion/forgiveness and body awareness';
                            negativeLabel = '-5 Avoidant/Racing Thoughts, Ruminating, Catastrophizing';
                        } else if (isSomatic) {
                            positiveLabel = '+5 Calm, relaxed, can easily tolerate discomforts';
                            neutralLabel = '0 Able to force tolerating discomforts while resting/relaxing';
                            negativeLabel = '-5 Body aches/pains or other physical symptoms';
                        } else if (isHousing) {
                            positiveLabel = '+5 Able to embrace, enjoy, or appreciate simple creature comforts';
                            neutralLabel = '0 Deeply Calm (Regulated)';
                            negativeLabel = '-5 Pressure to pursue or engage in home improvement projects';
                        } else if (isWorkMoney) {
                            positiveLabel = '+5 A calmable enthusiasm for work/money related tasks';
                            neutralLabel = '0 Have some willingness to pursue/engage in income generating efforts';
                            negativeLabel = '-5 Intense or persistent anticipation, rumination, or pressure to perform';
                        } else if (isMoneyHandling) {
                            positiveLabel = '+5 Curiosity or thinking about paying down debt or investing into business related things';
                            neutralLabel = '0 Not really thinking or worrying about money or resources at all';
                            negativeLabel = '-5 Fear about financial failure or obsessions about money monitoring';
                        } else if (isSpiritual) {
                            positiveLabel = '+5 Able and willing to practice tolerance of information while interacting';
                            neutralLabel = '0 Can neutralize overly negative thoughts/narratives';
                            negativeLabel = '-5 Resentments, blaming, catastrophizing, external critic, and prolonged avoidance';
                        } else if (isFreedomLevel) {
                            positiveLabel = '+5 Supportive random synchronicities, consilience leading to approachability';
                            neutralLabel = '0 Neutral or between the extremes';
                            negativeLabel = '-5 Parts of society/other people are unsupportive of my needs and wants';
                        } else {
                            positiveLabel = '+5 Enthusiasm/Fun';
                            neutralLabel = '0 Deeply Calm (Regulated)';
                            negativeLabel = '-5 Fear, Anger, or Activated (Dysregulated)';
                        }
                        
                        return `
                        <div class="slider-container">
                            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 3px;">
                                <div style="flex: 1;">
                                    <div class="slider-header" style="margin-bottom: 0;">
                                        <span class="slider-label">${label}</span>
                                        <span class="slider-value" style="color: ${getSliderColor(-area.value)};">${getLifeAreaDisplayValue(area.value)}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 4px;">
                                    <button class="btn" onclick="toggleLifeAreaLock('${key}')" 
                                            style="padding: 4px 8px; font-size: 11px; ${area.locked ? 'background: #f59e0b; color: white;' : 'background: #16a34a; color: white;'}">
                                        ${area.locked ? 'Unlock' : 'Lock'}
                                    </button>
                                </div>
                            </div>
                            <div class="slider-labels"><span>${positiveLabel}</span><span>${neutralLabel}</span><span>${negativeLabel}</span></div>
                            <input type="range" min="-7" max="7" value="${area.value}" 
                                   onchange="updateSlider('life', '${key}', this.value)"
                                   ${area.locked ? 'disabled' : ''}
                                   style="background: linear-gradient(to right, #64ff64 0%, #4488ff 50%, #ffaa44 75%, #ff4444 100%); ${area.locked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                        </div>
                    `;
                    }).join('')}
                    
                    </div>
                    
                    <div class="subtotal">
                        <div class="subtotal-text">Life Areas Net: ${lifeTotal} (negative = draining, positive = energizing)</div>
                    </div>
                </div>

                <div class="card section-purple">
                    <h2>2. Specific Internal Experiences (Emotions, Vibes, Somatic/Bodily Activity) (0-10 each)</h2>
                    <div class="subtitle"><em>Rate and describe what you're carrying internally</em></div>
                    
                    <div class="examples-box">
                        ${!state.section2DescExpanded ? `
                            <div style="margin-bottom: 6px;">
                                <div style="font-size: 13px; color: #374151; line-height: 1.6;">
                                    <strong>Threat Response (Dysregulated)</strong> â€¢ <strong>Grounded, calm, and approachable (Regulated)</strong> â€¢ <strong>Opportunity Responses</strong>
                                </div>
                            </div>
                            <button class="btn" onclick="toggleSection2Desc()" 
                                    style="padding: 4px 8px; font-size: 11px; background: #6b7280; color: white;">
                                Show More â–¼
                            </button>
                        ` : `
                            <div style="margin-bottom: 9px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                    <div class="examples-title">Three types of internal responses:</div>
                                    <button class="btn" onclick="toggleSection2Desc()" 
                                            style="padding: 4px 8px; font-size: 11px; background: #6b7280; color: white;">
                                        Hide â–²
                                    </button>
                                </div>
                                <textarea id="section2DescTextarea" 
                                          onchange="updateSection2Desc(this.value)" 
                                          oninput="autoResizeTextarea(this)"
                                          style="width: 100%; min-height: 120px; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 13px; font-family: inherit; line-height: 1.5; resize: none; overflow: hidden;">${state.section2DescText}</textarea>
                                <div style="font-size: 11px; color: #6b7280; margin-top: 3px; font-style: italic;">
                                    Changes are saved automatically
                                </div>
                            </div>
                        `}
                    </div>

                    ${state.ambient.map((amb, i) => `
                        <div class="slider-container" style="position: relative;">
                            <div style="display: flex; gap: 8px; align-items: flex-start;">
                                <div style="flex: 1;">
                                    <label class="input-label">Note/Description:</label>
                                    <textarea onchange="updateAmbient(${amb.id}, 'note', this.value)"
                                              placeholder="Brief description or context..."
                                              ${amb.locked ? 'disabled' : ''}
                                              style="${amb.locked ? 'opacity: 0.6; cursor: not-allowed; background: #f3f4f6;' : ''}">${amb.note}</textarea>
                                    
                                    <div class="slider-header" style="margin-top: 9px;">
                                        <span class="slider-label">Intensity/Loudness</span>
                                        <span class="slider-value" style="color: ${amb.type === 'threat' ? '#f44336' : amb.type === 'regulated' ? '#1976d2' : '#4caf50'};">${amb.value}</span>
                                    </div>
                                    <input type="range" min="0" max="10" value="${amb.value}" 
                                           onchange="updateAmbient(${amb.id}, 'value', this.value)"
                                           ${amb.locked ? 'disabled' : ''}
                                           style="background: ${getAmbientSliderGradient(amb.type, amb.value)}; ${amb.locked ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <div class="slider-labels"><span>0 Not present</span><span>10 Very present</span></div>
                                    
                                    <label class="input-label" style="margin-top: 9px;">Type:</label>
                                    <select onchange="updateAmbient(${amb.id}, 'type', this.value)" 
                                            ${amb.locked ? 'disabled' : ''}
                                            style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 14px; ${amb.locked ? 'opacity: 0.6; cursor: not-allowed; background: #f3f4f6;' : ''}">
                                        <option value="threat" ${amb.type === 'threat' ? 'selected' : ''}>Threat Response (Dysregulated)</option>
                                        <option value="regulated" ${amb.type === 'regulated' ? 'selected' : ''}>Grounded, calm, and approachable (Regulated)</option>
                                        <option value="opportunity" ${amb.type === 'opportunity' ? 'selected' : ''}>Opportunity Responses</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 20px;">
                                    <button class="btn" onclick="toggleAmbientLock(${amb.id})" 
                                            style="padding: 4px 8px; font-size: 11px; white-space: nowrap; ${amb.locked ? 'background: #f59e0b; color: white;' : 'background: #3b82f6; color: white;'}">
                                        ${amb.locked ? 'Edit' : 'Save'}
                                    </button>
                                    <button class="btn" onclick="deleteAmbientSlider(${amb.id})" 
                                            style="padding: 4px 8px; font-size: 11px; white-space: nowrap; background: #dc2626; color: white;">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                    
                    ${state.ambient.length < 6 ? `
                        <button class="btn" onclick="addAmbientSlider()" 
                                style="background: #9333ea; color: white; width: 100%; padding: 10px; margin-top: 9px;">
                            + Add Topic
                        </button>
                    ` : `
                        <div style="text-align: center; padding: 9px; color: #6b7280; font-style: italic; font-size: 13px;">
                            Maximum of 6 internal experiences reached
                        </div>
                    `}
                </div>

                <div class="card">
                    <h2>Window of Tolerance Visualization</h2>
                    <div class="visualization" id="visualization">
                        <div class="color-legend"></div>
                        
                        <div class="zone-labels">
                            <div class="zone-label">Threat Response (Dysregulated):<br>Fear, anxiety, activated feel, anger,<br>hopelessness, powerlessness,<br>and threat of pain responses</div>
                            <div class="zone-label">Grounded, calm,<br>and approachable (Regulated)</div>
                            <div class="zone-label">Opportunity Responses:<br>Enthusiasm, joy, sex, hunger,<br>expansiveness or freedom feelings</div>
                        </div>

                        <svg viewBox="0 0 600 300" preserveAspectRatio="none">
                            <defs>
                                <linearGradient id="waterGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#0088ff;stop-opacity:0.4" />
                                    <stop offset="100%" style="stop-color:#0088ff;stop-opacity:0.9" />
                                </linearGradient>
                            </defs>
                            <path id="riverChannel" class="river-channel" d=""/>
                            <path id="riverWater" class="river-water" d=""/>
                        </svg>

                        <div class="gate-top">
                            <div class="gate-shape-top" id="gateShapeTop">
                                <div class="gate-interior-top"></div>
                                <div class="gate-outline-top"></div>
                            </div>
                        </div>

                        <div class="gate-bottom">
                            <div class="gate-shape-bottom" id="gateShapeBottom">
                                <div class="gate-interior-bottom"></div>
                                <div class="gate-outline-bottom"></div>
                            </div>
                        </div>

                        <div class="gate-text-top" id="gateTextTop">THREAT<br>0</div>
                        <div class="gate-text-bottom" id="gateTextBottom">OPPORTUNITY<br>0</div>
                        <div class="river-text" id="riverText">Window of Tolerance Width<br>or Internal Information<br>Processing Capacity</div>
                        <div class="neutral-list" id="neutralList"></div>
                        
                        <div class="contributors-list contributors-threat" id="contributorsThreat"></div>
                        <div class="contributors-list contributors-opportunity" id="contributorsOpportunity"></div>

                        <div class="ground-label">Window of Tolerance<br>Threat: ${threatLoad} | Regulated: ${regulatedLoad} | Opportunity: ${opportunityLoad}</div>
                    </div>
                </div>

                <div class="card" style="border: 2px solid #9333ea;">
                    <h2>System Load Summary</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 9px; margin: 12px 0;">
                        <div style="background: #fee2e2; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Threat Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #dc2626;">${threatLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Dysregulated</div>
                        </div>
                        <div style="background: #e3f2fd; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Regulated Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #1976d2;">${regulatedLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Grounded</div>
                        </div>
                        <div style="background: #d1fae5; padding: 9px; border-radius: 5px; text-align: center;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 3px;">Opportunity Load</div>
                            <div style="font-size: 28px; font-weight: bold; color: #16a34a;">${opportunityLoad}</div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 3px;">Enthusiasm/Fun</div>
                        </div>
                    </div>
                    <div class="status-box" style="background: ${status.color}; border-color: ${status.border}; color: ${status.textColor};">
                        <span class="status-icon">${status.icon}</span>
                        <span style="font-weight: 600;">${status.text}</span>
                    </div>
                </div>

                <div class="card" style="border: 2px solid #16a34a;">
                    <h2>ðŸ’¾ Save Current Entry</h2>
                    <div class="subtitle" style="margin-bottom: 12px;">Save a timestamped snapshot of all current ratings to Google Sheets</div>
                    
                    ${state.saveError ? `<div class="error-message">${state.saveError}</div>` : ''}
                    
                    <button class="btn btn-success" onclick="saveEntry()">Save Entry</button>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h2 style="margin: 0;">Saved Entries: ${state.entries.length}</h2>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn" style="background: #3b82f6; color: white;" onclick="copyEntries()" ${state.entries.length === 0 ? 'disabled style="background: #d1d5db; cursor: not-allowed;"' : ''}>ðŸ“‹ Copy All</button>
                            <button class="btn" style="background: #dc2626; color: white;" onclick="clearEntries()" ${state.entries.length === 0 ? 'disabled style="background: #d1d5db; cursor: not-allowed;"' : ''}>ðŸ—‘ï¸ Clear All</button>
                        </div>
                    </div>
                    
                    ${state.entries.length === 0 ? '<div style="text-align: center; padding: 36px 0; color: #6b7280;">No saved entries yet</div>' : `
                        <div style="max-height: 450px; overflow-y: auto;">
                            ${state.entries.map(e => `
                                <div class="entry-item">
                                    <div class="entry-timestamp">
                                        ${new Date(e.timestamp).toLocaleString()}
                                    </div>
                                    
                                    <div class="entry-section">
                                        <div class="entry-section-title">System Loads</div>
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 6px;">
                                            <div style="background: #fee2e2; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Threat</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #dc2626;">${e.threatLoad || 0}</div>
                                            </div>
                                            <div style="background: #e3f2fd; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Regulated</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #1976d2;">${e.regulatedLoad || 0}</div>
                                            </div>
                                            <div style="background: #d1fae5; padding: 6px; border-radius: 4px; text-align: center;">
                                                <div style="font-size: 10px; color: #6b7280;">Opportunity</div>
                                                <div style="font-size: 18px; font-weight: bold; color: #16a34a;">${e.opportunityLoad || 0}</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="entry-section">
                                        <div class="entry-section-title">Life Areas (Total: ${e.lifeTotal})</div>
                                        <div class="entry-life-areas">
                                            <div>Mental: <strong>${e.lifeAreas.mental}</strong></div>
                                            <div>Somatic/Body: <strong>${e.lifeAreas.somaticBody}</strong></div>
                                            <div>Emotional: <strong>${e.lifeAreas.emotional}</strong></div>
                                            <div>Housing/Comforts: <strong>${e.lifeAreas.housingComforts}</strong></div>
                                            <div>Work/Income: <strong>${e.lifeAreas.workMoney}</strong></div>
                                            <div>Money/Resources: <strong>${e.lifeAreas.moneyHandling || '00'}</strong></div>
                                            <div>Personal Relations: <strong>${e.lifeAreas.spiritual}</strong></div>
                                            <div>Spiritual Outlook: <strong>${e.lifeAreas.freedomLevel}</strong></div>
                                        </div>
                                    </div>

                                    <div class="entry-section">
                                        <div class="entry-section-title">Internal Experiences</div>
                                        ${e.ambient.filter(a => a.value !== 0).length === 0 ? 
                                            '<div style="font-style: italic; color: #6b7280; font-size: 12px;">No internal experiences recorded</div>' :
                                            e.ambient.filter(a => a.value !== 0).map((a, i) => {
                                                const typeLabels = {
                                                    'threat': 'Threat Response',
                                                    'regulated': 'Regulated/Grounded',
                                                    'opportunity': 'Opportunity Response'
                                                };
                                                return `
                                                <div class="entry-ambient">
                                                    <div class="entry-ambient-header">[${a.value}/10] - ${typeLabels[a.type] || a.type}</div>
                                                    <div class="entry-ambient-note">"${a.note}"</div>
                                                </div>
                                            `;
                                            }).join('')
                                        }
                                    </div>

                                    <div class="entry-total">
                                        Total Load: ${e.total} (${e.pct}%)
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;

            document.getElementById('app').innerHTML = html;
            
            // Auto-resize section 2 description textarea if it exists
            const section2Textarea = document.getElementById('section2DescTextarea');
            if (section2Textarea) {
                autoResizeTextarea(section2Textarea);
            }
            
            setTimeout(() => updateVisualization(threatLoad, opportunityLoad, regulatedLoad), 0);
        }

        render();
    </script>
</body>
</html>
