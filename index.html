<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offload: What would you like to offload?</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: left;
            margin-bottom: 6px;
            color: #333;
            font-size: 22px;
            font-weight: 700;
        }
        
        .subtitle-question {
            text-align: left;
            margin-bottom: 15px;
            color: #6b7280;
            font-size: 16px;
            font-weight: 500;
        }
        
        /* Builder sections */
        .builders-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .item-builder-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 8px;
            flex: 1;
        }
        
        /* Shared workspace */
        .shared-workspace {
            height: 120px;
            background: #f9fafb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 2px dashed #d1d5db;
            overflow-y: auto;
        }
        
        .workspace-empty {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9ca3af;
            font-style: italic;
            font-size: 28px;
        }
        
        .item-builder-section.stressors { 
            border: 2px solid #ff8888; 
            background: linear-gradient(to right, rgba(255, 235, 59, 0.25), rgba(255, 152, 0, 0.25), rgba(255, 68, 68, 0.25));
        }
        .item-builder-section.opportunities { 
            border: 2px solid #88ff88; 
            background: linear-gradient(to right, rgba(34, 197, 94, 0.25), rgba(255, 235, 59, 0.25));
        }
        .item-builder-section.supports { 
            border: 2px solid #4488ff; 
            background: linear-gradient(to right, rgba(156, 163, 175, 0.25), rgba(59, 130, 246, 0.25));
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .section-total {
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Visualization layout */
        .viz-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .viz-legend {
            flex: 0 0 15%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .viz-main {
            flex: 0 0 calc(60% - 8px);
        }
        
        .viz-sidebar {
            flex: 0 0 calc(25% - 8px);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        /* River box */
        .river-box {
            position: relative;
            width: 100%;
            height: 285px;
            border: 4px solid #333;
            border-radius: 8px;
            background: #f0f0f0;
            overflow: hidden;
        }
        
        .threat-zone {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to bottom, #ff4444, #ff8888);
            border-bottom: 3px solid #cc0000;
            transition: height 0.3s ease, background 0.3s ease, border-bottom-color 0.3s ease;
        }
        
        .opportunity-zone {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to top, #44ff44, #88ff88);
            border-top: 3px solid #00cc00;
            transition: height 0.3s ease;
        }
        
        .river {
            position: absolute;
            left: 0;
            width: 100%;
            top: 10px;
            height: 280px;
            background: linear-gradient(to bottom, 
                rgba(68, 136, 255, 0.4),
                rgba(68, 136, 255, 0.8),
                rgba(68, 136, 255, 0.4)
            );
            transition: top 0.3s ease, height 0.3s ease;
        }
        
        .river::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 40px,
                rgba(255, 255, 255, 0.3) 40px,
                rgba(255, 255, 255, 0.3) 80px
            );
            animation: flow 3s linear infinite;
        }
        
        @keyframes flow {
            from { transform: translateX(0); }
            to { transform: translateX(80px); }
        }
        
        .label {
            position: absolute;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            font-size: 18px;
            z-index: 10;
        }
        
        .threat-label {
            top: 15px;
            left: 20px;
        }
        
        .opportunity-label {
            bottom: 15px;
            left: 20px;
        }
        
        .zone-description {
            display: inline;
            font-size: 11px;
            font-weight: normal;
            margin-left: 12px;
        }
        
        .river-label {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 10;
        }
        
        /* Color legend from other tool */
        .legend-container {
            position: relative;
            width: 100%;
            height: 285px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .color-legend {
            position: relative;
            width: 100%;
            height: 266px;
            background: linear-gradient(to bottom,
                #ff4444 0%,
                #ffaa44 33%,
                #4488ff 66%,
                #44ff44 100%
            );
            border: 3px solid #333;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding: 15px 8px;
        }
        
        .legend-label {
            color: white;
            font-weight: bold;
            font-size: 11px;
            line-height: 1.3;
            text-align: center;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            padding: 4px;
        }
        
        /* Zone labels container */
        .zone-labels-container {
            position: absolute;
            left: 10%;
            right: 10px;
            top: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            pointer-events: none;
            z-index: 10;
        }
        
        .zone-labels-top {
            flex: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-start;
            padding: 0 10px 5px 10px;
            transition: all 0.3s ease-out;
        }
        
        .zone-labels-middle {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            padding: 5px 10px;
            transition: all 0.3s ease-out;
        }
        
        .zone-labels-bottom {
            flex: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-start;
            padding: 0 10px 5px 10px;
            margin-top: -8px;
            transition: all 0.3s ease-out;
        }
        
        .zone-item-label {
            color: white;
            font-weight: 600;
            text-shadow: none;
            font-size: 12px;
            padding: 4px 10px;
            margin: 3px 0;
            text-align: left;
            max-width: 100%;
            background: rgba(0,0,0,0.9);
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.3);
        }
        
        /* N/S/P Percentage displays */
        .zone-percentage {
            position: absolute;
            color: white;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.9);
            pointer-events: none;
            z-index: 11;
            transition: all 0.3s ease-out;
        }

        .zone-percentage-top {
            right: 10px;
            transform: translateY(-50%);
        }

        .zone-percentage-middle {
            right: 10px;
            transform: translateY(-50%);
        }

        .zone-percentage-bottom {
            right: 10px;
            transform: translateY(-50%);
        }
        
        .unicorn-float {
            position: absolute;
            font-size: 32px;
            z-index: 15;
            animation: drift 8s linear infinite;
            transition: top 0.3s ease-out;
        }
        
        @keyframes drift {
            0% { 
                left: -5%; 
                transform: translateY(0px);
            }
            12.5% {
                left: 11.25%;
                transform: translateY(-40px);
            }
            25% {
                left: 22.5%;
                transform: translateY(0px);
            }
            37.5% {
                left: 33.75%;
                transform: translateY(40px);
            }
            50% {
                left: 50%;
                transform: translateY(0px);
            }
            62.5% {
                left: 66.25%;
                transform: translateY(-40px);
            }
            75% {
                left: 77.5%;
                transform: translateY(0px);
            }
            87.5% {
                left: 88.75%;
                transform: translateY(40px);
            }
            100% { 
                left: 105%; 
                transform: translateY(0px);
            }
        }
        
        /* Sidebar */
        .sidebar-section {
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 4px;
            padding: 6px;
            flex: 1;
            overflow-y: auto;
        }
        
        .sidebar-section h4 {
            font-size: 10px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .sidebar-item {
            font-size: 10px;
            color: #374151;
            margin-bottom: 2px;
            line-height: 1.3;
        }
        
        .sidebar-total {
            font-size: 11px;
            font-weight: 700;
            color: #3b82f6;
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Custom slider styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 2px solid #333;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 2px solid #333;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 18px;
            }
            
            .subtitle-question {
                font-size: 14px;
            }
            
            /* Stack builders vertically on mobile */
            .builders-row {
                flex-direction: column;
            }
            
            .item-builder-section {
                width: 100%;
            }
            
            /* Stack visualization components vertically */
            .viz-container {
                flex-direction: column;
            }
            
            .viz-legend {
                flex: 0 0 auto;
                width: 100%;
                height: 80px;
                margin-bottom: 10px;
            }
            
            .legend-container {
                height: 80px;
            }
            
            .color-legend {
                height: 70px;
                flex-direction: row;
                padding: 8px 15px;
            }
            
            .legend-label {
                flex: 1;
                font-size: 8px;
                line-height: 1.1;
            }
            
            .viz-main {
                flex: 0 0 auto;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .river-box {
                height: 200px;
            }
            
            .viz-sidebar {
                flex: 0 0 auto;
                width: 100%;
                flex-direction: row;
                gap: 6px;
            }
            
            .sidebar-section {
                flex: 1;
            }
            
            /* Adjust zone labels for smaller viz */
            .zone-item-label {
                font-size: 10px;
                padding: 3px 6px;
            }
            
            .zone-percentage {
                font-size: 12px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Offload: A shadow work tool for nervous system regulation.</h1>
        
        <button id="toggleImageBtn" onclick="toggleImageContainer()" style="padding: 6px 12px; margin-bottom: 8px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">
            Hide Image Area
        </button>
        
        <!-- Window of Tolerance Image -->
        <div id="imageContainer" style="margin: 15px 0; padding: 20px; background: #fefefe; border-radius: 8px; border: 2px dashed #d1d5db; text-align: center; min-height: 400px; display: flex; align-items: center; justify-content: center; position: relative;">
            <img id="windowOfToleranceImg" 
                 src="" 
                 alt="Window of Tolerance Diagram" 
                 style="max-width: 100%; height: auto; max-height: 400px; object-fit: contain; display: none;">
            <div id="imagePlaceholder" style="color: #9ca3af; font-size: 14px;">
                <div style="margin-bottom: 10px; font-weight: 600;">Drop your Window of Tolerance image here</div>
                <div style="font-size: 12px;">or <label for="imageUpload" style="color: #3b82f6; cursor: pointer; text-decoration: underline;">click to browse</label></div>
                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            </div>
        </div>
        
        <div class="subtitle-question">What is on your mind or in your nerves?</div>
        
        <!-- Three builders in one row -->
        <div class="builders-row">
            <!-- Stressors Builder -->
            <div class="item-builder-section stressors">
                <div class="section-header">
                    <h3 class="section-title">Stressors / Activations</h3>
                    <div class="section-total" style="color: #dc2626;">
                        Total: <span id="totalStressors">0</span>
                    </div>
                </div>
                <button onclick="addStressor()" style="width: 100%; padding: 6px 12px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; margin-top: 4px;">
                    + Add Stressor
                </button>
            </div>
            
            <!-- Opportunities Builder -->
            <div class="item-builder-section opportunities">
                <div class="section-header">
                    <h3 class="section-title">Opportunities / Enthusiasm</h3>
                    <div class="section-total" style="color: #16a34a;">
                        Total: <span id="totalOpportunities">0</span>
                    </div>
                </div>
                <button onclick="addOpportunity()" style="width: 100%; padding: 6px 12px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; margin-top: 4px;">
                    + Add Opportunity
                </button>
            </div>
            
            <!-- Supports Builder -->
            <div class="item-builder-section supports">
                <div class="section-header">
                    <h3 class="section-title">Identify supports</h3>
                    <div class="section-total" style="color: #3b82f6;">
                        Total: <span id="totalSupports">0</span>
                    </div>
                </div>
                <button onclick="addSupport()" style="width: 100%; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; margin-top: 4px;">
                    + Add Support
                </button>
            </div>
        </div>
        
        <!-- Shared Workspace -->
        <div class="shared-workspace" id="sharedWorkspace">
            <div class="workspace-empty">Workspace: Click a button above to add an item</div>
        </div>
        
        
        <button id="unicornToggleBtn" onclick="toggleUnicorn()" style="width: auto; padding: 4px 12px; margin-bottom: 8px; background: #9333ea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 11px;">
            ü¶Ñ Show Unicorn
        </button>
        
        <!-- Summary Area Label -->
        <div style="margin-bottom: 8px; margin-top: 8px;">
            <h3 style="font-size: 16px; font-weight: 700; color: #333; margin: 0;">Summary Area</h3>
        </div>
        
        <!-- Visualization + Sidebar -->
        <div class="viz-container">
            <div class="viz-legend">
                <div class="legend-container">
                    <div class="color-legend">
                        <div class="legend-label">Threat Response<br>(Dysregulated)<br><span style="font-size: 9px;">Fear, anxiety, anger,<br>hopelessness,<br>threat of pain</span></div>
                        <div class="legend-label">Grounded, calm,<br>approachable<br>(Regulated)</div>
                        <div class="legend-label">Opportunity<br>Responses<br><span style="font-size: 9px;">Enthusiasm, joy,<br>hunger, expansiveness,<br>freedom feelings</span></div>
                    </div>
                </div>
            </div>
            
            <div class="viz-main">
                <div class="river-box">
                    <div class="threat-zone" id="threatZone"></div>
                    
                    <div class="river" id="river">
                        <div class="unicorn-float" id="unicornFloat" style="display: none;">ü¶Ñ</div>
                    </div>
                    
                    <div class="opportunity-zone" id="opportunityZone"></div>
                    
                    <div class="zone-percentage zone-percentage-top" id="zonePctTop">N: 0%</div>
                    <div class="zone-percentage zone-percentage-middle" id="zonePctMiddle">S: 0%</div>
                    <div class="zone-percentage zone-percentage-bottom" id="zonePctBottom">P: 0%</div>
                    
                    <div class="zone-labels-container">
                        <div class="zone-labels-top" id="zoneLabelsTop"></div>
                        <div class="zone-labels-middle" id="zoneLabelsMiddle"></div>
                        <div class="zone-labels-bottom" id="zoneLabelsBottom"></div>
                    </div>
                </div>
            </div>
            
            <div class="viz-sidebar">
                <div class="sidebar-section">
                    <h4>Stressors</h4>
                    <div id="sidebarStressors">
                        <div style="text-align: center; color: #9ca3af; font-size: 9px; padding: 6px;">No stressors</div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h4>Opportunities</h4>
                    <div id="sidebarOpportunities">
                        <div style="text-align: center; color: #9ca3af; font-size: 9px; padding: 6px;">No opportunities</div>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <h4>Supports</h4>
                    <div id="sidebarSupports">
                        <div style="text-align: center; color: #9ca3af; font-size: 9px; padding: 6px;">No supports</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Section -->
        <div style="margin-top: 15px; padding: 15px; background: #f9fafb; border-radius: 8px; border: 2px solid #16a34a;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3 style="margin: 0; font-size: 16px; color: #333;">Save Current State</h3>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="saveCurrentState()" style="flex: 1; padding: 10px; background: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üíæ Save Entry
                </button>
                <button onclick="pushToSpreadsheet()" style="flex: 1; padding: 10px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üìä Push to Spreadsheet
                </button>
                <button onclick="exportData()" style="padding: 10px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üìã Copy
                </button>
                <button onclick="clearHistory()" style="padding: 10px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    üóëÔ∏è Clear
                </button>
            </div>
            
            <div id="savedEntries" style="margin-top: 12px;">
                <div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 15px;">
                    No entries saved yet
                </div>
            </div>
        </div>
    </div>
    
    <!-- Life Areas Manager Modal -->
    <div id="lifeAreasModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div id="lifeAreasManagerContent"></div>
        </div>
    </div>

    <script>
        // Life areas for categorization - load from localStorage or use defaults
        let LIFE_AREAS = JSON.parse(localStorage.getItem('customLifeAreas')) || [
            'Work',
            'Personal',
            'Health'
        ];
        
        // Save life areas to localStorage
        function saveLifeAreas() {
            localStorage.setItem('customLifeAreas', JSON.stringify(LIFE_AREAS));
        }
        
        // Storage for all three types of items
        let stressors = [];
        let opportunities = [];
        let supports = [];
        
        // Offloaded items (shown only in sidebar, cleared from builders)
        let offloadedStressors = [];
        let offloadedOpportunities = [];
        let offloadedSupports = [];
        
        let itemIdCounter = 0;
        let savedEntries = [];
        let showUnicorn = false; // Start with unicorn hidden
        
        const savedStates = {
            stressors: {},
            opportunities: {},
            supports: {}
        };
        
        // Add functions
        function addStressor() {
            // Clear any un-offloaded items from other categories
            opportunities = [];
            supports = [];
            
            const id = itemIdCounter++;
            stressors.push({ id, label: '', value: 0, note: '', lifeAreas: [] });
            savedStates.stressors[id] = { label: '', value: 0, note: '', lifeAreas: [] };
            renderItems('stressors');
            updateRiver();
        }
        
        function addOpportunity() {
            // Clear any un-offloaded items from other categories
            stressors = [];
            supports = [];
            
            const id = itemIdCounter++;
            opportunities.push({ id, label: '', value: 0, note: '', lifeAreas: [] });
            savedStates.opportunities[id] = { label: '', value: 0, note: '', lifeAreas: [] };
            renderItems('opportunities');
            updateRiver();
        }
        
        function addSupport() {
            // Clear any un-offloaded items from other categories
            stressors = [];
            opportunities = [];
            
            const id = itemIdCounter++;
            supports.push({ id, label: '', value: 0, note: '', lifeAreas: [] });
            savedStates.supports[id] = { label: '', value: 0, note: '', lifeAreas: [] };
            renderItems('supports');
            updateRiver();
        }
        
        // Delete function
        function deleteItem(type, id) {
            if (type === 'stressors') {
                stressors = stressors.filter(s => s.id !== id);
                delete savedStates.stressors[id];
            } else if (type === 'opportunities') {
                opportunities = opportunities.filter(o => o.id !== id);
                delete savedStates.opportunities[id];
            } else if (type === 'supports') {
                supports = supports.filter(s => s.id !== id);
                delete savedStates.supports[id];
            }
            renderItems(type);
            updateRiver();
        }
        
        // Offload function - moves item to sidebar permanently and clears from builder
        function offloadItem(type, id) {
            let sourceArray = type === 'stressors' ? stressors : type === 'opportunities' ? opportunities : supports;
            let targetArray = type === 'stressors' ? offloadedStressors : type === 'opportunities' ? offloadedOpportunities : offloadedSupports;
            
            // Check if already at max (3 items per category)
            if (targetArray.length >= 3) {
                alert(`Maximum of 3 ${type} can be offloaded. Please edit/remove an existing item first.`);
                return;
            }
            
            const item = sourceArray.find(i => i.id === id);
            if (item) {
                // Move to offloaded array
                targetArray.push({...item});
                
                // Remove from active builder array
                if (type === 'stressors') {
                    stressors = stressors.filter(s => s.id !== id);
                } else if (type === 'opportunities') {
                    opportunities = opportunities.filter(o => o.id !== id);
                } else {
                    supports = supports.filter(s => s.id !== id);
                }
                
                renderItems(type);
                updateRiver();
                
                // Visual feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úì Offloaded';
                btn.style.background = '#059669';
                setTimeout(() => {
                    // Button will be gone after render, so this just helps with timing
                }, 500);
            }
        }
        
        // Edit function - brings offloaded item back to builder
        function editOffloadedItem(type, id) {
            let sourceArray = type === 'stressors' ? offloadedStressors : type === 'opportunities' ? offloadedOpportunities : offloadedSupports;
            let targetArray = type === 'stressors' ? stressors : type === 'opportunities' ? opportunities : supports;
            
            const item = sourceArray.find(i => i.id === id);
            if (item) {
                // Move back to builder array
                targetArray.push({...item});
                
                // Remove from offloaded array
                if (type === 'stressors') {
                    offloadedStressors = offloadedStressors.filter(s => s.id !== id);
                } else if (type === 'opportunities') {
                    offloadedOpportunities = offloadedOpportunities.filter(o => o.id !== id);
                } else {
                    offloadedSupports = offloadedSupports.filter(s => s.id !== id);
                }
                
                renderItems(type);
                updateRiver();
            }
        }
        
        // Update function
        function updateItem(type, id, field, value) {
            let array = type === 'stressors' ? stressors : type === 'opportunities' ? opportunities : supports;
            const item = array.find(i => i.id === id);
            if (item) {
                item[field] = field === 'value' ? parseInt(value) : value;
                updateTotals();
                updateRiver();
            }
        }
        
        // Handle life area dropdown selection
        function handleLifeAreaSelect(type, id, value) {
            if (value === '__manage__') {
                openLifeAreasManager();
            } else if (value) {
                addLifeArea(type, id, value);
            }
        }
        
        // Add life area from dropdown
        function addLifeArea(type, id, area) {
            if (!area) return;
            
            let array = type === 'stressors' ? stressors : type === 'opportunities' ? opportunities : supports;
            const item = array.find(i => i.id === id);
            if (item) {
                if (!item.lifeAreas) item.lifeAreas = [];
                
                if (item.lifeAreas.length >= 3) {
                    alert('Maximum of 3 life areas can be selected');
                    return;
                }
                
                if (!item.lifeAreas.includes(area)) {
                    item.lifeAreas.push(area);
                    renderItems(type);
                }
            }
        }
        
        // Remove life area
        function removeLifeArea(type, id, area) {
            let array = type === 'stressors' ? stressors : type === 'opportunities' ? opportunities : supports;
            const item = array.find(i => i.id === id);
            if (item && item.lifeAreas) {
                item.lifeAreas = item.lifeAreas.filter(a => a !== area);
                renderItems(type);
            }
        }
        
        // Open life areas manager modal
        function openLifeAreasManager() {
            // Initialize temp storage with current values
            tempLifeAreas = [...LIFE_AREAS];
            hasUnsavedChanges = false;
            
            const modal = document.getElementById('lifeAreasModal');
            modal.style.display = 'flex';
            renderLifeAreasManager();
        }
        
        // Close life areas manager modal
        function closeLifeAreasManager() {
            const modal = document.getElementById('lifeAreasModal');
            modal.style.display = 'none';
        }
        
        // Render life areas manager content
        function renderLifeAreasManager() {
            const container = document.getElementById('lifeAreasManagerContent');
            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #333;">Manage Life Areas</h3>
                    <p style="margin: 0; font-size: 12px; color: #6b7280;">Customize the life areas that appear in your dropdowns. (Max 10 life areas total, max 3 per item)</p>
                </div>
                
                <div style="margin-bottom: 15px;">
                    ${tempLifeAreas.map((area, index) => `
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb;">
                            <input 
                                type="text" 
                                value="${area}"
                                onchange="updateLifeArea(${index}, this.value)"
                                style="flex: 1; padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px;">
                            <button 
                                onclick="deleteLifeArea(${index})"
                                style="padding: 4px 8px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                Delete
                            </button>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-bottom: 15px;">
                    <input 
                        type="text" 
                        id="newLifeAreaInput"
                        placeholder="New life area name..."
                        style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; margin-bottom: 8px;">
                    <button 
                        onclick="addNewLifeArea()"
                        style="width: 100%; padding: 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px;">
                        + Add Life Area
                    </button>
                </div>
                
                ${hasUnsavedChanges ? `
                <button 
                    id="saveLifeAreasBtn"
                    onclick="saveLifeAreaChanges()"
                    style="width: 100%; padding: 10px; background: #16a34a; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px; margin-bottom: 8px;">
                    üíæ Save Changes
                </button>
                ` : ''}
                
                <button 
                    onclick="closeLifeAreasManager()"
                    style="width: 100%; padding: 10px; background: ${hasUnsavedChanges ? '#6b7280' : '#3b82f6'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 14px;">
                    ${hasUnsavedChanges ? 'Cancel' : 'Done'}
                </button>
            `;
        }
        
        // Temporary storage for life area edits
        let tempLifeAreas = [];
        let hasUnsavedChanges = false;
        
        // Add new life area (to temp storage)
        function addNewLifeArea() {
            const input = document.getElementById('newLifeAreaInput');
            const newArea = input.value.trim();
            
            if (!newArea) {
                alert('Please enter a life area name');
                return;
            }
            
            if (tempLifeAreas.includes(newArea)) {
                alert('This life area already exists');
                return;
            }
            
            if (tempLifeAreas.length >= 10) {
                alert('Maximum of 10 life areas allowed in the master list');
                return;
            }
            
            tempLifeAreas.push(newArea);
            hasUnsavedChanges = true;
            renderLifeAreasManager();
            input.value = '';
        }
        
        // Update life area name (in temp storage)
        function updateLifeArea(index, newName) {
            newName = newName.trim();
            if (!newName) {
                alert('Life area name cannot be empty');
                renderLifeAreasManager();
                return;
            }
            
            if (tempLifeAreas.includes(newName) && tempLifeAreas[index] !== newName) {
                alert('This life area name already exists');
                renderLifeAreasManager();
                return;
            }
            
            tempLifeAreas[index] = newName;
            hasUnsavedChanges = true;
            renderLifeAreasManager();
        }
        
        // Delete life area (from temp storage)
        function deleteLifeArea(index) {
            if (!confirm('Are you sure you want to delete this life area? It will be removed from all existing items.')) {
                return;
            }
            
            tempLifeAreas.splice(index, 1);
            hasUnsavedChanges = true;
            renderLifeAreasManager();
        }
        
        // Save all life area changes
        function saveLifeAreaChanges() {
            // Track what changed for updating items
            const oldAreas = [...LIFE_AREAS];
            
            // Apply all changes
            LIFE_AREAS = [...tempLifeAreas];
            
            // Update all existing items that reference old life areas
            [...offloadedStressors, ...offloadedOpportunities, ...offloadedSupports, ...stressors, ...opportunities, ...supports].forEach(item => {
                if (item.lifeAreas) {
                    // Remove any life areas that no longer exist
                    item.lifeAreas = item.lifeAreas.filter(area => LIFE_AREAS.includes(area));
                }
            });
            
            saveLifeAreas();
            hasUnsavedChanges = false;
            
            // Show success feedback
            const saveBtn = document.getElementById('saveLifeAreasBtn');
            if (saveBtn) {
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '‚úì Saved!';
                saveBtn.style.background = '#059669';
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '#16a34a';
                }, 1500);
            }
            
            renderLifeAreasManager();
        }
        
        // Update totals
        function updateTotals() {
            const stressorTotal = stressors.reduce((sum, s) => sum + s.value, 0) + 
                                  offloadedStressors.reduce((sum, s) => sum + s.value, 0);
            const opportunityTotal = opportunities.reduce((sum, o) => sum + o.value, 0) + 
                                     offloadedOpportunities.reduce((sum, o) => sum + o.value, 0);
            const supportTotal = supports.reduce((sum, s) => sum + s.value, 0) + 
                                 offloadedSupports.reduce((sum, s) => sum + s.value, 0);
            
            document.getElementById('totalStressors').textContent = stressorTotal;
            document.getElementById('totalOpportunities').textContent = opportunityTotal;
            document.getElementById('totalSupports').textContent = supportTotal;
            
            return { stressorTotal, opportunityTotal, supportTotal };
        }
        
        // Render items
        function renderItems(type) {
            const workspace = document.getElementById('sharedWorkspace');
            if (!workspace) return;
            
            let array, color, typeName;
            
            if (type === 'stressors') {
                array = stressors;
                color = '#ef4444';
                typeName = 'Stressor';
            } else if (type === 'opportunities') {
                array = opportunities;
                color = '#22c55e';
                typeName = 'Opportunity';
            } else {
                array = supports;
                color = '#3b82f6';
                typeName = 'Support';
            }
            
            // If no items, show empty message
            if (array.length === 0) {
                workspace.innerHTML = '<div class="workspace-empty">Workspace: Click a button above to add an item</div>';
                updateTotals();
                return;
            }
            
            // Show the most recent item (last in array)
            const item = array[array.length - 1];
            
            workspace.innerHTML = `
                <div style="background: white; padding: 6px; border-radius: 4px; margin-bottom: 6px; border: 2px solid #d1d5db;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                        <div style="flex: 1; display: flex; align-items: center; gap: 6px;">
                            <input type="text" 
                                   value="${item.label}"
                                   onchange="updateItem('${type}', ${item.id}, 'label', this.value)"
                                   placeholder="Name this..."
                                   style="flex: 0 0 35%; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            <select 
                                   onchange="handleLifeAreaSelect('${type}', ${item.id}, this.value); this.value='';"
                                   style="flex: 1; padding: 4px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 11px; color: #374151;">
                                <option value="">+ Add life area (max of 3)</option>
                                ${LIFE_AREAS.map(area => 
                                    `<option value="${area}" ${(item.lifeAreas || []).includes(area) ? 'disabled' : ''}>${area}</option>`
                                ).join('')}
                                <option value="__manage__" style="border-top: 1px solid #d1d5db;">‚öôÔ∏è Manage life areas...</option>
                            </select>
                            <span style="font-weight: bold; color: ${color}; font-size: 14px; min-width: 22px; text-align: center;">${item.value}</span>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <button onclick="offloadItem('${type}', ${item.id})" style="padding: 3px 10px; background: #16a34a; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                Offload
                            </button>
                            <button onclick="deleteItem('${type}', ${item.id})" style="padding: 3px 8px; background: #dc2626; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                Delete
                            </button>
                        </div>
                    </div>
                    
                    <!-- Selected Life Areas Display -->
                    ${(item.lifeAreas || []).length > 0 ? `
                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 4px;">
                        ${(item.lifeAreas || []).map(area => `
                            <span style="padding: 2px 8px; font-size: 10px; background: #3b82f6; color: white; border-radius: 3px; display: inline-flex; align-items: center; gap: 4px;">
                                ${area}
                                <button onclick="removeLifeArea('${type}', ${item.id}, '${area}')" style="background: none; border: none; color: white; cursor: pointer; padding: 0; font-size: 12px; line-height: 1;">√ó</button>
                            </span>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <textarea 
                        placeholder="Add notes..."
                        onchange="updateItem('${type}', ${item.id}, 'note', this.value)"
                        style="width: 100%; padding: 4px; border: 1px solid #d1d5db; border-radius: 3px; font-size: 11px; min-height: 30px; margin-bottom: 4px; resize: vertical; font-family: inherit;">${item.note || ''}</textarea>
                    <div style="display: flex; align-items: center; gap: 4px;">
                        <span style="font-size: 10px; color: #6b7280; font-weight: 600;">0</span>
                        <input type="range" 
                               min="0" 
                               max="10" 
                               value="${item.value}"
                               oninput="updateItem('${type}', ${item.id}, 'value', this.value)"
                               style="flex: 1; background: ${type === 'stressors' ? 'linear-gradient(to right, #ffeb3b, #ff9800, #ff4444)' : type === 'opportunities' ? 'linear-gradient(to right, #22c55e, #ffeb3b)' : 'linear-gradient(to right, #9ca3af, #3b82f6)'};">
                        <span style="font-size: 10px; color: #6b7280; font-weight: 600;">10</span>
                    </div>
                </div>
            `;
            
            updateTotals();
        }
        
        // Toggle builders visibility
        function toggleBuilders() {
            const builders = document.querySelectorAll('.item-builder-section');
            const btn = document.getElementById('toggleBuildersText');
            const isHidden = builders[0].style.display === 'none';
            
            builders.forEach(b => b.style.display = isHidden ? 'block' : 'none');
            btn.textContent = isHidden ? 'Hide Builders' : 'Show Builders';
        }
        
        // Update sidebar
        function updateSidebar() {
            // Stressors sidebar - show offloaded items with edit buttons
            const sidebarStressors = document.getElementById('sidebarStressors');
            if (offloadedStressors.length === 0) {
                sidebarStressors.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 9px; padding: 6px;">No stressors</div>';
            } else {
                const stressorTotal = offloadedStressors.reduce((sum, s) => sum + s.value, 0);
                sidebarStressors.innerHTML = offloadedStressors.map(s => 
                    `<div class="sidebar-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${s.label || 'Unnamed'}: <strong>${s.value}</strong></span>
                        <button onclick="editOffloadedItem('stressors', ${s.id})" style="padding: 2px 6px; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">Edit/View Details</button>
                    </div>`
                ).join('') + 
                `<div class="sidebar-total" style="color: #dc2626;">Total: ${stressorTotal}</div>`;
            }
            
            // Opportunities sidebar - show offloaded items with edit buttons
            const sidebarOpportunities = document.getElementById('sidebarOpportunities');
            if (offloadedOpportunities.length === 0) {
                sidebarOpportunities.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 9px; padding: 6px;">No opportunities</div>';
            } else {
                const opportunityTotal = offloadedOpportunities.reduce((sum, o) => sum + o.value, 0);
                sidebarOpportunities.innerHTML = offloadedOpportunities.map(o => 
                    `<div class="sidebar-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${o.label || 'Unnamed'}: <strong>${o.value}</strong></span>
                        <button onclick="editOffloadedItem('opportunities', ${o.id})" style="padding: 2px 6px; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">Edit/View Details</button>
                    </div>`
                ).join('') + 
                `<div class="sidebar-total" style="color: #16a34a;">Total: ${opportunityTotal}</div>`;
            }
            
            // Supports sidebar - show offloaded items with edit buttons
            const sidebarSupports = document.getElementById('sidebarSupports');
            if (offloadedSupports.length === 0) {
                sidebarSupports.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 9px; padding: 6px;">No supports</div>';
            } else {
                const supportTotal = offloadedSupports.reduce((sum, s) => sum + s.value, 0);
                sidebarSupports.innerHTML = offloadedSupports.map(s => 
                    `<div class="sidebar-item" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${s.label || 'Unnamed'}: <strong>${s.value}</strong></span>
                        <button onclick="editOffloadedItem('supports', ${s.id})" style="padding: 2px 6px; background: #3b82f6; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 9px;">Edit/View Details</button>
                    </div>`
                ).join('') + 
                `<div class="sidebar-total">Total: ${supportTotal}</div>`;
            }
        }
        
        // Update river visualization - PUSH FROM BOTH SIDES
        function updateRiver() {
            // Check if mobile (screen width <= 768px)
            const isMobile = window.innerWidth <= 768;
            const boxHeight = isMobile ? 200 : 285;
            
            const minZoneHeight = boxHeight * 0.10;
            const maxRiverHeight = isMobile ? 180 : 265; // Cap river at initial size
            
            const totals = updateTotals();
            const stressorTotal = totals.stressorTotal;
            const opportunityTotal = totals.opportunityTotal;
            const supportTotal = totals.supportTotal;
            
            // Calculate ideal heights without constraints
            // Stressors want to push down (8 pixels per point)
            let idealStressHeight = minZoneHeight + (stressorTotal * 8);
            
            // Opportunities want to push up (8 pixels per point)
            let idealOpportunityHeight = minZoneHeight + (opportunityTotal * 8);
            
            // Supports want to expand the river (6 pixels per point)
            let riverExpansion = supportTotal * 6;
            
            // Start with natural river space, then add support expansion
            let idealRiverHeight = boxHeight - idealStressHeight - idealOpportunityHeight + riverExpansion;
            
            // Cap river at maximum
            idealRiverHeight = Math.min(idealRiverHeight, maxRiverHeight);
            idealRiverHeight = Math.max(boxHeight * 0.10, idealRiverHeight);
            
            // Now figure out actual heights
            let actualStressHeight = idealStressHeight;
            let actualOpportunityHeight = idealOpportunityHeight;
            let actualRiverHeight = idealRiverHeight;
            
            // If everything doesn't fit, supports need to push back proportionally on both zones
            const totalWanted = idealStressHeight + idealOpportunityHeight + idealRiverHeight;
            if (totalWanted > boxHeight) {
                // Calculate how much we need to compress
                const excess = totalWanted - boxHeight;
                
                // River expansion from supports should push back proportionally on both zones
                // Split the pushback based on the relative size of stress vs opportunity
                const stressRatio = idealStressHeight / (idealStressHeight + idealOpportunityHeight);
                const oppRatio = idealOpportunityHeight / (idealStressHeight + idealOpportunityHeight);
                
                // Reduce both zones proportionally
                actualStressHeight = idealStressHeight - (excess * stressRatio);
                actualOpportunityHeight = idealOpportunityHeight - (excess * oppRatio);
                
                // Keep minimums
                actualStressHeight = Math.max(minZoneHeight, actualStressHeight);
                actualOpportunityHeight = Math.max(minZoneHeight, actualOpportunityHeight);
                
                // River gets whatever's left
                actualRiverHeight = boxHeight - actualStressHeight - actualOpportunityHeight;
            }
            
            // Apply to DOM
            const threatZone = document.getElementById('threatZone');
            const opportunityZone = document.getElementById('opportunityZone');
            opportunityZone.style.height = actualOpportunityHeight + 'px';
            
            // Calculate threat zone color based on actual height (more height = more compressed river)
            let threatColor1, threatColor2, borderColor;
            
            // Yellow to orange to red based on how much space stress is taking
            if (actualStressHeight <= 100) {
                // Low stress: Yellow (taking less space)
                threatColor1 = '#ffeb3b';
                threatColor2 = '#fff176';
                borderColor = '#fbc02d';
            } else if (actualStressHeight <= 150) {
                // Medium stress: Orange (taking medium space)
                threatColor1 = '#ff9800';
                threatColor2 = '#ffb74d';
                borderColor = '#f57c00';
            } else {
                // High stress: Red (past middle, really squeezing river)
                threatColor1 = '#ff4444';
                threatColor2 = '#ff8888';
                borderColor = '#cc0000';
            }
            
            threatZone.style.background = `linear-gradient(to bottom, ${threatColor1}, ${threatColor2})`;
            threatZone.style.borderBottomColor = borderColor;
            threatZone.style.height = actualStressHeight + 'px';
            
            // Calculate opportunity zone color based on actual height
            let oppColor1, oppColor2, oppBorderColor;
            
            // Green to lime to gray-yellow based on how much space opportunity is taking
            if (actualOpportunityHeight <= 100) {
                // Low opportunity: Green (taking less space)
                oppColor1 = '#44ff44';
                oppColor2 = '#88ff88';
                oppBorderColor = '#00cc00';
            } else if (actualOpportunityHeight <= 150) {
                // Medium opportunity: Light green/lime (taking medium space)
                oppColor1 = '#88ff44';
                oppColor2 = '#aaff88';
                oppBorderColor = '#66cc00';
            } else {
                // High opportunity: Gray-yellow (past middle, really squeezing river)
                oppColor1 = '#d4d08a';
                oppColor2 = '#e8e4b0';
                oppBorderColor = '#a8a070';
            }
            
            opportunityZone.style.background = `linear-gradient(to top, ${oppColor1}, ${oppColor2})`;
            opportunityZone.style.borderTopColor = oppBorderColor;
            
            const river = document.getElementById('river');
            river.style.top = actualStressHeight + 'px';
            river.style.height = actualRiverHeight + 'px';
            
            // Calculate percentages
            const topPct = Math.round((actualStressHeight / boxHeight) * 100);
            const bottomPct = Math.round((actualOpportunityHeight / boxHeight) * 100);
            const middlePct = 100 - topPct - bottomPct;
            
            // Update percentage displays
            const pctTop = document.getElementById('zonePctTop');
            const pctMiddle = document.getElementById('zonePctMiddle');
            const pctBottom = document.getElementById('zonePctBottom');
            
            if (pctTop) {
                pctTop.textContent = `N: ${topPct}%`;
                pctTop.style.top = (actualStressHeight / 2) + 'px';
                pctTop.style.fontSize = '16px';
            }
            
            if (pctMiddle) {
                pctMiddle.textContent = `S: ${middlePct}%`;
                pctMiddle.style.top = (actualStressHeight + actualRiverHeight / 2) + 'px';
                pctMiddle.style.fontSize = '16px';
            }
            
            if (pctBottom) {
                pctBottom.textContent = `P: ${bottomPct}%`;
                pctBottom.style.top = (boxHeight - actualOpportunityHeight / 2) + 'px';
                pctBottom.style.fontSize = '16px';
            }
            
            updateSidebar();
            updateZoneLabels(actualStressHeight, actualRiverHeight, actualOpportunityHeight);
        }
        
        // Toggle unicorn visibility
        function toggleUnicorn() {
            showUnicorn = !showUnicorn;
            const unicorn = document.getElementById('unicornFloat');
            const btn = document.getElementById('unicornToggleBtn');
            
            if (unicorn) {
                unicorn.style.display = showUnicorn ? 'block' : 'none';
            }
            if (btn) {
                btn.textContent = showUnicorn ? 'ü¶Ñ Hide Unicorn' : 'ü¶Ñ Show Unicorn';
            }
        }
        
        // Update zone labels with offloaded items
        function updateZoneLabels(stressHeight, riverHeight, opportunityHeight) {
            const topZone = document.getElementById('zoneLabelsTop');
            const middleZone = document.getElementById('zoneLabelsMiddle');
            const bottomZone = document.getElementById('zoneLabelsBottom');
            const unicorn = document.getElementById('unicornFloat');
            
            if (!topZone || !middleZone || !bottomZone) return;
            
            const boxHeight = 285;
            
            // Update flex sizes based on actual zone heights
            topZone.style.flex = `0 0 ${stressHeight}px`;
            middleZone.style.flex = `0 0 ${riverHeight}px`;
            bottomZone.style.flex = `0 0 ${opportunityHeight}px`;
            
            // Position unicorn in the center of the river
            // Make it bounce to touch both boundaries
            if (unicorn) {
                const riverCenter = stressHeight + (riverHeight / 2);
                unicorn.style.top = riverCenter + 'px';
                
                // Calculate bounce height to reach from center to boundaries
                // Bounce should be half the river height to touch both edges
                const bounceHeight = (riverHeight / 2) - 16; // -16 for emoji size
                
                // Update CSS animation dynamically with new bounce height
                const styleSheet = document.styleSheets[0];
                // Remove old drift animation if it exists
                for (let i = styleSheet.cssRules.length - 1; i >= 0; i--) {
                    if (styleSheet.cssRules[i].name === 'drift') {
                        styleSheet.deleteRule(i);
                        break;
                    }
                }
                // Add new drift animation with calculated bounce
                const driftKeyframes = `
                    @keyframes drift {
                        0% { left: -5%; transform: translateY(0px); }
                        12.5% { left: 11.25%; transform: translateY(-${bounceHeight}px); }
                        25% { left: 22.5%; transform: translateY(0px); }
                        37.5% { left: 33.75%; transform: translateY(${bounceHeight}px); }
                        50% { left: 50%; transform: translateY(0px); }
                        62.5% { left: 66.25%; transform: translateY(-${bounceHeight}px); }
                        75% { left: 77.5%; transform: translateY(0px); }
                        87.5% { left: 88.75%; transform: translateY(${bounceHeight}px); }
                        100% { left: 105%; transform: translateY(0px); }
                    }
                `;
                styleSheet.insertRule(driftKeyframes, styleSheet.cssRules.length);
            }
            
            // Populate with offloaded items
            topZone.innerHTML = offloadedStressors.length > 0
                ? offloadedStressors.map(s => `<div class="zone-item-label">${s.label || 'Unnamed'} (${s.value})</div>`).join('')
                : '<div class="zone-item-label" style="opacity: 0.5;">No stressors</div>';
            
            middleZone.innerHTML = offloadedSupports.length > 0
                ? offloadedSupports.map(s => `<div class="zone-item-label">${s.label || 'Unnamed'} (${s.value})</div>`).join('')
                : '<div class="zone-item-label" style="opacity: 0.5;">No supports</div>';
            
            bottomZone.innerHTML = offloadedOpportunities.length > 0
                ? offloadedOpportunities.map(o => `<div class="zone-item-label">${o.label || 'Unnamed'} (${o.value})</div>`).join('')
                : '<div class="zone-item-label" style="opacity: 0.5;">No opportunities</div>';
        }
        
        // Save current state
        function saveCurrentState() {
            const totals = updateTotals();
            
            const entry = {
                timestamp: new Date().toLocaleString(),
                stressors: offloadedStressors.map(s => ({ label: s.label, value: s.value, note: s.note })),
                opportunities: offloadedOpportunities.map(o => ({ label: o.label, value: o.value, note: o.note })),
                supports: offloadedSupports.map(s => ({ label: s.label, value: s.value, note: s.note })),
                totals: totals
            };
            
            savedEntries.unshift(entry);
            renderSavedEntries();
            
            const saveBtn = event.target;
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '‚úì Saved!';
            saveBtn.style.background = '#059669';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = '#16a34a';
            }, 1500);
        }
        
        // Push to Google Sheets
        function pushToSpreadsheet() {
            const totals = updateTotals();
            
            const entry = {
                timestamp: new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles' }),
                stressors: offloadedStressors.map(s => ({ label: s.label, value: s.value, note: s.note })),
                opportunities: offloadedOpportunities.map(o => ({ label: o.label, value: o.value, note: o.note })),
                supports: offloadedSupports.map(s => ({ label: s.label, value: s.value, note: s.note })),
                stressorTotal: totals.stressorTotal,
                opportunityTotal: totals.opportunityTotal,
                supportTotal: totals.supportTotal
            };
            
            // Push to Google Sheets
            fetch('https://script.google.com/macros/s/AKfycbwmsjZwezZy792u76y2Sw8GgACnq0turMk3R95a8BfTtlwTVddINlhGJFTk5zIPObrlQg/exec', {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(entry)
            }).then(() => {
                console.log('Data sent to Google Sheets');
                
                const pushBtn = event.target;
                const originalText = pushBtn.innerHTML;
                pushBtn.innerHTML = '‚úì Pushed!';
                pushBtn.style.background = '#059669';
                setTimeout(() => {
                    pushBtn.innerHTML = originalText;
                    pushBtn.style.background = '#8b5cf6';
                }, 1500);
            }).catch(error => {
                console.error('Error sending to Google Sheets:', error);
            });
        }
        
        // Render saved entries
        function renderSavedEntries() {
            const container = document.getElementById('savedEntries');
            
            if (savedEntries.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9ca3af; font-size: 13px; padding: 15px;">No entries saved yet</div>';
                return;
            }
            
            container.innerHTML = savedEntries.map((entry, index) => `
                <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #d1d5db;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <div style="font-weight: 600; color: #111827; font-size: 13px;">${entry.timestamp}</div>
                        <button onclick="deleteEntry(${index})" style="padding: 4px 8px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                            Delete
                        </button>
                    </div>
                    
                    <div style="font-size: 12px; color: #374151; line-height: 1.6;">
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #dc2626;">Stressors (${entry.totals.stressorTotal}):</strong><br>
                            ${entry.stressors.length > 0 
                                ? entry.stressors.map(s => `‚Ä¢ ${s.label || 'Unnamed'} (${s.value})${s.note ? ': ' + s.note : ''}`).join('<br>') 
                                : 'None'}
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #16a34a;">Opportunities (${entry.totals.opportunityTotal}):</strong><br>
                            ${entry.opportunities.length > 0 
                                ? entry.opportunities.map(o => `‚Ä¢ ${o.label || 'Unnamed'} (${o.value})${o.note ? ': ' + o.note : ''}`).join('<br>') 
                                : 'None'}
                        </div>
                        <div>
                            <strong style="color: #3b82f6;">Supports (${entry.totals.supportTotal}):</strong><br>
                            ${entry.supports.length > 0 
                                ? entry.supports.map(s => `‚Ä¢ ${s.label || 'Unnamed'} (${s.value})${s.note ? ': ' + s.note : ''}`).join('<br>') 
                                : 'None'}
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Delete entry
        function deleteEntry(index) {
            if (confirm('Delete this entry?')) {
                savedEntries.splice(index, 1);
                renderSavedEntries();
            }
        }
        
        // Export data
        function exportData() {
            if (savedEntries.length === 0) {
                alert('No entries to export');
                return;
            }
            
            const header = ['Timestamp', 'Stressor Total', 'Stressors', 'Opportunity Total', 'Opportunities', 'Support Total', 'Supports'];
            const rows = savedEntries.map(e => [
                e.timestamp,
                e.totals.stressorTotal,
                e.stressors.map(s => `${s.label || 'Unnamed'}(${s.value})`).join('; '),
                e.totals.opportunityTotal,
                e.opportunities.map(o => `${o.label || 'Unnamed'}(${o.value})`).join('; '),
                e.totals.supportTotal,
                e.supports.map(s => `${s.label || 'Unnamed'}(${s.value})`).join('; ')
            ]);
            
            const tsv = [header.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
            navigator.clipboard.writeText(tsv);
            
            alert('Copied to clipboard! Paste into a spreadsheet.');
        }
        
        // Clear history
        function clearHistory() {
            if (confirm('Clear all saved entries? This cannot be undone.')) {
                savedEntries = [];
                renderSavedEntries();
            }
        }
        
        // Toggle image container visibility
        function toggleImageContainer() {
            const imageContainer = document.getElementById('imageContainer');
            const toggleBtn = document.getElementById('toggleImageBtn');
            const isHidden = imageContainer.style.display === 'none';
            
            if (isHidden) {
                imageContainer.style.display = 'flex';
                toggleBtn.textContent = 'Hide Image Area';
                localStorage.setItem('imageContainerHidden', 'false');
            } else {
                imageContainer.style.display = 'none';
                toggleBtn.textContent = 'Show Image Area';
                localStorage.setItem('imageContainerHidden', 'true');
            }
        }
        
        // Initialize
        updateRiver();
        
        // Restore image container visibility from localStorage
        const imageContainerHidden = localStorage.getItem('imageContainerHidden');
        if (imageContainerHidden === 'true') {
            document.getElementById('imageContainer').style.display = 'none';
            document.getElementById('toggleImageBtn').textContent = 'Show Image Area';
        }
        
        // Image upload handling
        const imageContainer = document.getElementById('imageContainer');
        const imageUpload = document.getElementById('imageUpload');
        const windowImg = document.getElementById('windowOfToleranceImg');
        const placeholder = document.getElementById('imagePlaceholder');
        
        function handleImageLoad(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                windowImg.src = e.target.result;
                windowImg.style.display = 'block';
                placeholder.style.display = 'none';
                imageContainer.style.border = '2px solid #d1d5db';
                imageContainer.style.minHeight = 'auto';
                
                // Save to localStorage so it persists
                localStorage.setItem('windowOfToleranceImage', e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        // Load saved image from localStorage
        const savedImage = localStorage.getItem('windowOfToleranceImage');
        if (savedImage) {
            windowImg.src = savedImage;
            windowImg.style.display = 'block';
            placeholder.style.display = 'none';
            imageContainer.style.border = '2px solid #d1d5db';
            imageContainer.style.minHeight = 'auto';
        }
        
        // File input handler
        imageUpload.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                handleImageLoad(e.target.files[0]);
            }
        });
        
        // Drag and drop handlers
        imageContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            imageContainer.style.borderColor = '#3b82f6';
            imageContainer.style.background = '#eff6ff';
        });
        
        imageContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            imageContainer.style.borderColor = '#d1d5db';
            imageContainer.style.background = '#fefefe';
        });
        
        imageContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            imageContainer.style.borderColor = '#d1d5db';
            imageContainer.style.background = '#fefefe';
            
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                handleImageLoad(e.dataTransfer.files[0]);
            }
        });
    </script>
</body>
</html>
